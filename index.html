<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dots N Boxes - The Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue, off, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAdgoa6Qdbc4SXzhv-G8QtRQg5jSSUDvNo",
      authDomain: "dotsandboxes-83ea3.firebaseapp.com",
      databaseURL: "https://dotsandboxes-83ea3-default-rtdb.firebaseio.com",
      projectId: "dotsandboxes-83ea3",
      storageBucket: "dotsandboxes-83ea3.firebasestorage.app",
      messagingSenderId: "534312059101",
      appId: "1:534312059101:web:03e26a8e29fd7362989b34",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Make database globally accessible
    window.database = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
    window.firebaseUpdate = update;
    window.firebaseOnValue = onValue;
    window.firebaseOff = off;
    window.firebasePush = push;
    window.firebaseRemove = remove;

    // Global user variable
    let currentUser = null;
    
    // Guest UID storage
    const guestUIDs = new Set();

    // Login functions
    window.googleLogin = async function() {
      const provider = new GoogleAuthProvider();
      try {
        document.getElementById('loader').style.display = 'block';
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        await saveUser(user);
        showHome(user);
      } catch (error) {
        console.error("Google login error:", error);
        alert("Login failed: " + error.message);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    };

    window.facebookLogin = async function() {
      const provider = new FacebookAuthProvider();
      try {
        document.getElementById('loader').style.display = 'block';
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        await saveUser(user);
        showHome(user);
      } catch (error) {
        console.error("Facebook login error:", error);
        alert("Login failed: " + error.message);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    };

    window.guestLogin = async function() {
      try {
        document.getElementById('loader').style.display = 'block';
        
        // Check if we already have a guest UID stored
        let guestUID = localStorage.getItem('guestUID');
        let guestName = localStorage.getItem('guestName');
        
        if (!guestUID) {
          // Generate new guest UID and name
          guestUID = generateGuestUID();
          guestName = generateUniqueGuestName();
          
          // Store for future use
          localStorage.setItem('guestUID', guestUID);
          localStorage.setItem('guestName', guestName);
        }
        
        // Sign in anonymously with Firebase
        const result = await signInAnonymously(auth);
        const user = result.user;
        
        // Override the UID and display name with our persistent guest values
        user.uid = guestUID;
        user.displayName = guestName;
        
        await saveUser(user);
        showHome(user);
      } catch (error) {
        console.error("Guest login error:", error);
        alert("Login failed: " + error.message);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    };

    // Generate persistent guest UID
    function generateGuestUID() {
      let uid = localStorage.getItem('guestUID');
      if (!uid) {
        uid = 'guest_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
      }
      return uid;
    }

    // Generate unique guest name
    function generateUniqueGuestName() {
      let guestName = localStorage.getItem('guestName');
      if (!guestName) {
        guestName = "Guest_" + Math.floor(100000 + Math.random() * 900000);
      }
      return guestName;
    }

    // Save user to database
    async function saveUser(user) {
      const userRef = ref(database, 'users/' + user.uid);
      const snapshot = await get(userRef);
      
      if (!snapshot.exists()) {
        // New user
        const userData = {
          uid: user.uid,
          email: user.email || null,
          displayName: user.displayName || generateUniqueGuestName(),
          photoURL: user.photoURL || "https://www.gravatar.com/avatar/?d=mp",
          coins: 200,
          createdAt: Date.now(),
          lastLogin: Date.now(),
          matchHistory: {
            ai: { total: 0, win: 0, loss: 0, draw: 0 },
            local: { total: 0, win: 0, loss: 0, draw: 0 },
            global: { total: 0, win: 0, loss: 0, draw: 0 },
          }
        };
        await set(userRef, userData);
        currentUser = userData;
      } else {
        // Existing user - update last login
        const userData = snapshot.val();
        userData.lastLogin = Date.now();
        await update(userRef, { lastLogin: Date.now() });
        currentUser = userData;
      }
      
      // Store in localStorage for quick access
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }

    // Show home screen
    window.showHome = function(user) {
      document.getElementById('login-screen').classList.remove('active');
      document.getElementById('home-screen').classList.add('active');
      
      // Update user info in home screen
      if (user) {
        document.getElementById('userName').textContent = user.displayName || "Player";
        document.getElementById('userPhoto').src = user.photoURL || "https://www.gravatar.com/avatar/?d=mp";
        document.getElementById('coinCount').textContent = user.coins || 0;
        
        // Update match history
        if (user.matchHistory) {
          document.getElementById("matchTotal-ai").textContent = user.matchHistory.ai.total || 0;
          document.getElementById("matchWin-ai").textContent = user.matchHistory.ai.win || 0;
          document.getElementById("matchLoss-ai").textContent = user.matchHistory.ai.loss || 0;
          document.getElementById("matchDraw-ai").textContent = user.matchHistory.ai.draw || 0;
          
          document.getElementById("matchTotal-local").textContent = user.matchHistory.local.total || 0;
          document.getElementById("matchWin-local").textContent = user.matchHistory.local.win || 0;
          document.getElementById("matchLoss-local").textContent = user.matchHistory.local.loss || 0;
          document.getElementById("matchDraw-local").textContent = user.matchHistory.local.draw || 0;
          
          document.getElementById("matchTotal-global").textContent = user.matchHistory.global.total || 0;
          document.getElementById("matchWin-global").textContent = user.matchHistory.global.win || 0;
          document.getElementById("matchLoss-global").textContent = user.matchHistory.global.loss || 0;
          document.getElementById("matchDraw-global").textContent = user.matchHistory.global.draw || 0;
        }
      }
    };

    // Logout function
    window.logoutPlayer = function() {
      showLogoutConfirmation();
    };

    window.confirmLogout = function() {
      signOut(auth).then(() => {
        currentUser = null;
        localStorage.removeItem('currentUser');
        document.getElementById('home-screen').classList.remove('active');
        document.getElementById('login-screen').classList.add('active');
        hideLogoutConfirmation();
      }).catch((error) => {
        console.error("Logout error:", error);
      });
    };

    window.cancelLogout = function() {
      hideLogoutConfirmation();
    };

    // Show/hide logout confirmation
    function showLogoutConfirmation() {
      document.getElementById('logout-confirmation').style.display = 'flex';
    }

    function hideLogoutConfirmation() {
      document.getElementById('logout-confirmation').style.display = 'none';
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in
        const userRef = ref(database, 'users/' + user.uid);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          currentUser = snapshot.val();
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          showHome(currentUser);
        }
      } else {
        // User is signed out
        currentUser = null;
        localStorage.removeItem('currentUser');
        document.getElementById('home-screen').classList.remove('active');
        document.getElementById('login-screen').classList.add('active');
      }
    });

    // Check for existing user in localStorage on page load
    window.addEventListener('DOMContentLoaded', () => {
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        showHome(currentUser);
      }
    });
  </script>
  <style>
    /* ------------------------------------------- */
    /* --- Login Screen Styles --- */
    /* ------------------------------------------- */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1f2833, #333d4a);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    #login-screen:not(.active) {
      display: none;
    }
    
    .login-container {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-width: 400px;
      width: 90%;
    }
    
    .login-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      margin-bottom: 30px;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      background-image: linear-gradient(45deg, #ff6b6b, #48dbfb, #1abc9c, #3498db);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .login-subtitle {
      font-family: 'Roboto', sans-serif;
      font-size: 18px;
      margin-bottom: 30px;
      color: #aaa;
    }
    
    .login-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      height: 50px;
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    #googleLogin {
      background: white;
      color: #333;
    }
    
    #facebookLogin {
      background: #3b5998;
      color: white;
    }
    
    #guestLogin {
      background: #555;
      color: white;
    }
    
    .loader {
      display: none;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ------------------------------------------- */
    /* --- Logout Confirmation Styles --- */
    /* ------------------------------------------- */
    #logout-confirmation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    
    .logout-confirm-box {
      background: linear-gradient(135deg, #1f2833, #333d4a);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .logout-confirm-box h3 {
      margin-bottom: 20px;
      color: white;
      font-size: 24px;
    }
    
    .logout-confirm-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .logout-confirm-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    #logout-yes {
      background: #e74c3c;
      color: white;
    }
    
    #logout-no {
      background: #3498db;
      color: white;
    }
    
    .logout-confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* ------------------------------------------- */
    /* --- General & Home Screen Styles --- */
    /* ------------------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #1f2833, #333d4a);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      position: relative;
    }
    .game-section {
      width: 100%;
      max-width: 600px;
      display: none;
      background: linear-gradient(135deg, #1f2833, #333d4a);
      border-radius: 15px;
      margin: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.2);
      padding: 20px;
      color: white;
      text-align: center;
    }
    .game-section.active {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .top-bar {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 10px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .logout-btn, .settings {
      cursor: pointer;
      font-size: 22px;
      color: #aaa;
      transition: color 0.3s;
    }
    .logout-btn:hover, .settings:hover {
        color: #fff;
    }
    .profile {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }
    .profile img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid #ccc;
    }
    .container {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
    }
    h1 {
      font-size: 40px;
      margin-bottom: 10px;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      background-image: linear-gradient(45deg, #ff6b6b, #48dbfb, #1abc9c, #3498db);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .coin-display {
      margin: 10px 0;
      font-size: 18px;
      color: white;
    }
    .daily-reward {
      margin: 20px 0;
      background: linear-gradient(180deg, #ffd700, #ffc107);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 16px;
      display: inline-block;
      cursor: pointer;
      border: 2px solid #e2a800;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      color: #333;
      font-weight: bold;
    }
    .daily-reward:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    .daily-reward.claimed {
      cursor: not-allowed;
      opacity: 0.5;
      background: #ccc;
      color: #666;
      border: 2px solid #999;
      box-shadow: none;
    }
    .daily-reward.claiming::after {
      content: 'üí∞';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      animation: coin-pop 0.5s ease-out forwards;
    }
    @keyframes coin-pop {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -150%) scale(1.5);
        opacity: 0;
      }
    }
    .game-modes {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
      width: 100%;
      max-width: 400px;
    }
    .mode-btn {
      background: linear-gradient(180deg, #42a5f5, #1976d2);
      border: none;
      color: white;
      padding: 16px;
      border-radius: 12px;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      font-weight: bold;
    }
    .mode-btn:nth-child(2) { background: linear-gradient(180deg, #66bb6a, #388e3c); }
    .mode-btn:nth-child(3) { background: linear-gradient(180deg, #ffb74d, #f57c00); }
    .mode-btn:nth-child(4) { background: linear-gradient(180deg, #ffb74d, #f57c00); } /* Invite Friend */

    .mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    .mode-btn.disabled,
    .mode-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .popup-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .popup-content {
        background: linear-gradient(135deg, #1f2833, #333d4a);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        max-width: 450px;
        width: 90%;
        position: relative;
        text-align: center;
    }
    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .rewards-list button {
        background: linear-gradient(180deg, #ffd700, #ffc107);
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        width: 100%;
        margin-top: 10px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: transform 0.2s;
    }
    .rewards-list button:disabled {
        background: #ccc;
        cursor: not-allowed;
        color: #666;
        box-shadow: none;
    }
    .rewards-list button:active {
        transform: translateY(1px);
    }
    .rewards-item {
        margin-bottom: 20px;
    }
    .rewards-item .logo {
        font-size: 2em;
        margin-bottom: 10px;
        display: block;
    }
    
    #settings-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1f2833, #333d4a);
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      color: white;
    }
    .settings-content {
        width: 100%;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #settings-screen.active {
      display: flex;
    }
    #settings-screen h2 {
      margin-bottom: 20px;
      color: white;
    }
    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 20px;
    }
    .settings-header h2 {
        margin: 0;
    }
    .section {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .section h3 {
        margin-bottom: 15px;
        color: #42a5f5;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 5px;
    }
    .input-group {
      margin-bottom: 15px;
      text-align: left;
      display: flex;
        flex-direction: column;
    }
    .input-group.inline {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-weight: bold;
    }
    input, select, .toggle-switch {
      width: 100%;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 5px;
      background: #333;
      color: white;
      font-size: 16px;
    }
    .match-history-table {
        width: 100%;
        border-collapse: collapse;
        color: #aaa;
        font-size: 14px;
    }
    .match-history-table th, .match-history-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #444;
    }
    .match-history-table th {
        color: #42a5f5;
    }
    .toggle-switch {
        position: relative;
        width: 60px;
        height: 34px;
        padding: 0;
        border: none;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #555;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #2196F3;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    .input-group.inline label {
        margin-bottom: 0;
    }
    .email-btn {
        background: #03a9f4;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .game-options-screen {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
    }
    .game-options-screen h2 {
      margin-bottom: 20px;
      color: white;
    }
    .game-options-screen .option-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .game-options-screen label {
      font-size: 18px;
      font-weight: bold;
      color: #aaa;
    }
    .option-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .option-buttons button {
      padding: 10px 15px;
      background-color: #555;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: white;
      transition: all 0.2s ease;
      font-weight: bold;
    }
    .option-buttons button.selected {
      background-color: #1976d2;
      border-color: #0d47a1;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #ai-start-btn, #local-start-btn, #local-start-game-btn {
      margin-top: 20px;
      background: linear-gradient(180deg, #4caf50, #2e7d32);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    #ai-start-btn:disabled, #local-start-btn:disabled, #local-start-game-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* ------------------------------------------- */
    /* --- Game Play Styles (AI & Local) --- */
    /* ------------------------------------------- */
    #ai-game, #local-game {
      padding: 20px;
    }
    .game-screen-top-bar {
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }
    .player-score {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      position: relative;
    }
    .player-logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        position: relative;
        padding-top: 15px;
    }
    .player-logo-container .emoji {
        font-size: 24px;
        position: relative;
    }
    .turn-indicator {
        position: absolute;
        top: 0;
        width: 100%;
        height: 5px;
        border-radius: 5px;
        display: none;
    }
    .turn-indicator.active {
        display: block;
    }
    .turn-indicator.active.pulse {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
    #ai-player-indicator { background-color: #1976d2; }
    #ai-ai-indicator { background-color: #d32f2f; }
    #local-p1-indicator { background-color: #1976d2; }
    #local-p2-indicator { background-color: #d32f2f; }
    
    .score-value {
        font-size: 20px;
        margin-top: 5px;
    }
    .game-screen-bottom-bar {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      position: relative;
    }
    .game-screen-bottom-bar button {
        background: #03a9f4;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        position: relative;
    }
    .game-screen-bottom-bar #hint-btn {
        background: #ffb74d;
    }
    #ai-popup, #local-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1f2833, #333d4a);
      border: 2px solid #3498db;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      display: none;
      z-index: 100;
      text-align: center;
      color: white;
    }
    #ai-popup h2, #local-popup h2 {
      margin-top: 0;
      font-size: 2em;
      color: #ffc107;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    #ai-popup p, #local-popup p {
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    #ai-popup button, #local-popup button {
      background: #3498db;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .game-play-background {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: -1;
        background-size: cover;
        background-position: center;
        transition: background-image 0.5s ease-in-out;
    }
    .coming-soon-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 10px;
        z-index: 1000;
        font-size: 24px;
        text-align: center;
        cursor: pointer;
    }
    .consecutive-box-popup {
        display: none;
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        color: white;
        border-radius: 10px;
        z-index: 1001;
        font-size: 2em;
        text-align: center;
        opacity: 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .consecutive-box-popup.show {
        display: block;
        animation: fadeAndMove 2s forwards;
    }
    .consecutive-box-popup.good-job {
        background: linear-gradient(45deg, #1976d2, #42a5f5);
    }
    .consecutive-box-popup.great {
        background: linear-gradient(45deg, #388e3c, #66bb6a);
    }
    .consecutive-box-popup.fantastic {
        background: linear-gradient(45deg, #f57c00, #ffb74d);
    }
    @keyframes fadeAndMove {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        100% { transform: translate(-50%, -150%) scale(0.5); opacity: 0; }
    }
    #sparkle-canvas {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 101;
    }
    .hint-glow {
      animation: hintGlow 1.5s infinite ease-in-out;
      opacity: 0.8;
    }
    @keyframes hintGlow {
        0% { box-shadow: 0 0 5px 2px rgba(255, 255, 255, 0.7); }
        50% { box-shadow: 0 0 10px 4px rgba(255, 255, 255, 1); }
        100% { box-shadow: 0 0 5px 2px rgba(255, 255, 255, 0.7); }
    }
    #first-time-hint-popup {
      position: absolute;
      top: -40px;
      right: 0;
      background: #fff;
      color: #333;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
      animation: bounce 1s infinite;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    /* ------------------------------------------- */
    /* --- Global Multiplayer Styles --- */
    /* ------------------------------------------- */
    .global-coming-soon-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1f2833, #333d4a);
      color: white;
      border: 2px solid #3498db;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      text-align: center;
      z-index: 2000;
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -40%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .global-coming-soon-popup h2 {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #ffc107;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .global-coming-soon-popup p {
      font-size: 1.2em;
      margin-bottom: 25px;
      line-height: 1.6;
      max-width: 400px;
    }
    .global-coming-soon-popup button {
      background: linear-gradient(180deg, #42a5f5, #1976d2);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .global-coming-soon-popup button:hover {
        transform: translateY(-2px);
    }
    
    /* New styles for the online game back button */
    .back-btn {
      background: linear-gradient(180deg, #ef5350, #d32f2f);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      font-weight: bold;
      margin-top: 10px;
      width: auto;
    }

    /* ------------------------------------------- */
    /* --- Invite Friend Multiplayer Styles --- */
    /* ------------------------------------------- */
    .custom-action-btn {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        margin-top: 10px;
        border: none;
        color: white;
        width: auto; /* Allow sizing based on padding */
    }
    #create-room-btn {
        background: linear-gradient(180deg, #4caf50, #2e7d32); /* Green */
    }
    #join-room-final-btn {
        background: linear-gradient(180deg, #ffeb3b, #fbc02d); /* Yellow */
        color: #333;
    }
    #waiting-lobby-play-btn {
        background: linear-gradient(180deg, #2196f3, #1976d2); /* Blue */
        display: none; /* Only show for creator */
    }
    
    /* Multiplayer Game Screen */
    #multiplayer-game {
        padding: 20px;
    }
    .game-screen-top-bar {
        width: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
    }
    
    /* Timer Text (New) */
    #turn-timer-text {
        font-size: 24px;
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        background: rgba(0, 0, 0, 0.4);
        padding: 5px 10px;
        border-radius: 5px;
        min-width: 60px;
        z-index: 10;
    }

    #multi-p1-indicator, #local-p1-indicator { background-color: #1976d2; }
    #multi-p2-indicator, #local-p2-indicator { background-color: #d32f2f; }
    
    .game-screen-bottom-bar {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        position: relative;
    }
    
    /* Chat Icon */
    #chat-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        background-color: #42a5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10;
    }

    /* Quick Chat/Emoji Panel (Modified for Popup) */
    #quick-chat-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        background: linear-gradient(135deg, #333d4a, #1f2833);
        border: 2px solid #3498db;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        z-index: 1000;
        padding: 15px;
        display: none;
        flex-direction: column;
        gap: 10px;
    }
    #quick-chat-panel.active { display: flex; }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .chat-header h3 {
        margin: 0;
    }
    .chat-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
    }
    .chat-emoji-buttons button {
        flex: 1;
        padding: 8px;
        font-size: 24px;
    }
    .chat-quick-buttons button {
        width: 100%;
        margin-bottom: 5px;
        padding: 8px;
    }
    
    /* Emoji and Quick Chat Popups (MODIFIED SIZE) */
    .emoji-reaction-popup, .quick-chat-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px; /* Increased padding */
        border-radius: 15px;
        font-size: 3em; /* Significantly increased size */
        font-weight: bold;
        color: white;
        opacity: 0;
        pointer-events: none;
        z-index: 1001;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        animation: fade-pop-up 4s forwards;
    }
    @keyframes fade-pop-up {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        50% { opacity: 1; }
        100% { transform: translate(-50%, -150%) scale(0.5); opacity: 0; }
    }
    .quick-chat-popup {
        background-color: rgba(66, 165, 245, 0.9);
        font-size: 1.5em; /* Adjusted text size to look better with large emoji */
    }

    /* Lobby Screen (Retained) */
    .lobby-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    .room-code-display {
        background-color: #1976d2;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .player-slot {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        width: 80%;
        justify-content: center;
    }
  </style>
</head>
<body>
<!-- Login Screen -->
<section id="login-screen" class="game-section active">
  <div class="login-container">
    <h1 class="login-title">Welcome to Dots N Boxes</h1>
    <p class="login-subtitle">Sign in to start playing!</p>
    <div class="login-buttons">
      <button id="googleLogin" class="login-btn" onclick="googleLogin()">
        <span>üîç</span> Sign in with Google
      </button>
      <button id="facebookLogin" class="login-btn" onclick="facebookLogin()">
        <span>üìò</span> Login with Facebook
      </button>
      <button id="guestLogin" class="login-btn" onclick="guestLogin()">
        <span>üë§</span> Play as Guest
      </button>
    </div>
    <div id="loader" class="loader"></div>
  </div>
</section>

<!-- Logout Confirmation -->
<div id="logout-confirmation">
  <div class="logout-confirm-box">
    <h3>Are you sure you want to logout?</h3>
    <div class="logout-confirm-buttons">
      <button id="logout-no" class="logout-confirm-btn" onclick="cancelLogout()">No</button>
      <button id="logout-yes" class="logout-confirm-btn" onclick="confirmLogout()">Yes</button>
    </div>
  </div>
</div>

<div class="game-play-background" id="game-play-background"></div>
<audio id="background-music" loop>
  <source src="https://www.bensound.com/bensound-music/bensound-scifi.mp3" type="audio/mpeg">
</audio>
<audio id="intense-music" loop>
    <source src="https://www.bensound.com/bensound-music/bensound-creepy.mp3" type="audio/mpeg">
</audio>
<audio id="coin-sound" src="https://www.soundjay.com/button/button-3.mp3"></audio>
<audio id="tap-sound" src="https://www.soundjay.com/button/button-1.mp3"></audio>
<audio id="lineSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="boxSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

<div id="audio-controls" onclick="toggleAudio()">üîá</div>

<section id="home-screen" class="game-section">
  <div class="top-bar">
    <div class="profile">
      <label for="uploadPhoto" style="cursor:pointer;">
        <img src="https://www.gravatar.com/avatar/?d=mp" id="userPhoto" alt="User" />
      </label>
      <input type="file" id="uploadPhoto" style="display:none" accept="image/*" onchange="uploadProfilePic(event)"/>
      <span id="userName">Player</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <div class="logout-btn" onclick="logoutPlayer()">üö™</div>
        <div class="settings" onclick="openSettingsScreen()">‚öôÔ∏è</div>
    </div>
  </div>

  <div class="container">
    <h1>Dots N Boxes</h1>
    <div class="coin-display">üí∞ Coins: <span id="coinCount">0</span></div>
    <div class="daily-reward" id="freeRewardsBtn" onclick="showFreeRewardsPopup()">üéÅ Free Rewards</div>

    <div class="game-modes">
      <button class="mode-btn" onclick="showAiOptions()">ü§ñ Play vs AI</button>
      <button class="mode-btn" onclick="showLocalOptions()">üë• Local Multiplayer</button>
      <button class="mode-btn" onclick="showMultiplayerSetup()">ü§ù Invite Friend</button>
      <button class="mode-btn" id="globalMultiplayerBtn" onclick="showGlobalComingSoon()">üåç Global Multiplayer</button>
    </div>
  </div>
</section>

<div id="free-rewards-popup" class="popup-screen">
    <div class="popup-content">
        <button class="close-btn" onclick="hideFreeRewardsPopup()">‚ùå</button>
        <h2>üéÅ Free Rewards</h2>
        <div class="rewards-list">
            <div class="rewards-item">
                <span class="logo">üí∞</span>
                <h3>100 Daily Rewards</h3>
                <button id="dailyRewardClaimBtn" onclick="claimDailyReward()">Claim</button>
            </div>
            <div class="rewards-item">
                <span class="logo">üí∞</span>
                <h3>350 Coins</h3>
                <button id="adReward350Btn" onclick="watchAdAndClaim(350, '350')" data-next="500">Watch Ads</button>
            </div>
            <div class="rewards-item">
                <span class="logo">üí∞</span>
                <h3>500 Coins</h3>
                <button id="adReward500Btn" onclick="watchAdAndClaim(500, '500')" disabled data-next="700">Watch Ads</button>
            </div>
            <div class="rewards-item">
                <span class="logo">üí∞</span>
                <h3>700 Coins</h3>
                <button id="adReward700Btn" onclick="watchAdAndClaim(700, '700')" disabled>Watch Ads</button>
            </div>
        </div>
    </div>
</div>

<section id="settings-screen" class="game-section">
    <div class="settings-content">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-btn" onclick="closeSettingsScreen()">‚ùå</button>
        </div>
        <div class="section">
          <h3>Account</h3>
          <div class="input-group">
            <label for="playerName">Player Name</label>
            <input type="text" id="playerName" placeholder="Enter name" onchange="saveSettings()"/>
          </div>
          <div class="input-group">
            <label for="country">Country</label>
            <select id="country" onchange="saveSettings()">
              <option value="in">üáÆüá≥ India</option>
              <option value="us">üá∫üá∏ USA</option>
              <option value="gb">üá¨üáß UK</option>
              <option value="fr">üá´üá∑ France</option>
              <option value="de">üá©üá™ Germany</option>
            </select>
          </div>
        </div>
        <div class="section">
            <h3>Match History</h3>
            <table class="match-history-table">
                <thead>
                    <tr>
                        <th>Mode</th>
                        <th>Total</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Draws</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Play vs AI</td>
                        <td id="matchTotal-ai">0</td>
                        <td id="matchWin-ai">0</td>
                        <td id="matchLoss-ai">0</td>
                        <td id="matchDraw-ai">0</td>
                    </tr>
                    <tr>
                        <td>Local Multi</td>
                        <td id="matchTotal-local">0</td>
                        <td id="matchWin-local">0</td>
                        <td id="matchLoss-local">0</td>
                        <td id="matchDraw-local">0</td>
                    </tr>
                    <tr>
                        <td>Global Multi</td>
                        <td id="matchTotal-global">0</td>
                        <td id="matchWin-global">0</td>
                        <td id="matchLoss-global">0</td>
                        <td id="matchDraw-global">0</td>
                    </tbody>
            </table>
        </div>
        <div class="section">
            <h3>Audio</h3>
            <div class="input-group inline">
                <label for="musicToggle">Background Music</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="musicToggle" checked onchange="toggleBackgroundMusic()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="input-group inline">
                <label for="sfxToggle">Sound Effects</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="sfxToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="section">
            <h3>Visuals</h3>
            <div class="input-group">
                <label for="dotColor">Dot Color</label>
                <select id="dotColor" onchange="updateDotColor(); saveSettings()">
                    <option value="#FFFFFF">White</option>
                    <option value="#1976d2">Blue</option>
                    <option value="#388e3c">Green</option>
                    <option value="#fbc02d">Yellow</option>
                    <option value="#d32f2f">Red</option>
                </select>
            </div>
            <div class="input-group">
                <label for="lineColor">Line Color</label>
                <input type="color" id="lineColor" value="#1976d2" onchange="updateLineColor()">
            </div>
            <div class="input-group">
                <label for="boxFillColor">Box Fill Color (Player 1)</label>
                <select id="boxFillColor" onchange="updateBoxFillColor(); saveSettings()">
                    <option value="#1976d2">Blue</option>
                    <option value="#FFFFFF">White</option>
                    <option value="#388e3c">Green</option>
                    <option value="#fbc02d">Yellow</option>
                    <option value="#d32f2f">Red</option>
                </select>
            </div>
            <div class="input-group">
                <label for="gameBackground">Game Background</label>
                <select id="gameBackground" onchange="updateGameBackground(this.value)">
                    <option value="none">None</option>
                    <option value="stars">Stars</option>
                    <option value="wood">Wood</option>
                    <option value="circuit">Circuit Board</option>
                    <option value="galaxy">Galaxy</option>
                </select>
            </div>
        </div>
        <div class="section">
            <h3>Gameplay</h3>
            <div class="input-group inline">
                <label for="extraTurnToggle">Extra Turn on Box Completion</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="extraTurnToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="input-group">
                <label for="animationSpeed">Animation Speed</label>
                <select id="animationSpeed">
                    <option value="slow">Slow</option>
                    <option value="normal" selected>Normal</option>
                    <option value="fast">Fast</option>
                </select>
            </div>
        </div>
        <div class="section">
            <h3>Help & Support</h3>
            <div class="input-group">
                <button class="email-btn" onclick="contactDeveloper()">Contact Us</button>
            </div>
            <p>Version: 1.3.0</p>
            <p>Developer: Shivam Yadav</p>
        </div>
    </div>
</section>

<section id="ai-options-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Play vs AI</h2>
        <div class="option-group">
            <label>Select Grid Size</label>
            <div class="option-buttons" id="ai-grid-options">
                <button data-size="4" onclick="selectAiGrid(4, this)">4x4</button>
                <button data-size="5" onclick="selectAiGrid(5, this)">5x5</button>
                <button data-size="6" onclick="selectAiGrid(6, this)">6x6</button>
                <button data-size="7" onclick="selectAiGrid(7, this)">7x7</button>
                <button data-size="8" onclick="selectAiGrid(8, this)">8x8</button>
                <button data-size="9" onclick="selectAiGrid(9, this)">9x9</button>
            </div>
        </div>
        <div class="option-group">
            <label>Select Difficulty</label>
            <div class="option-buttons" id="ai-difficulty-options">
                <button data-difficulty="easy" onclick="selectAiDifficulty('easy', this)">Easy</button>
                <button data-difficulty="medium" onclick="selectAiDifficulty('medium', this)">Medium</button>
                <button data-difficulty="hard" onclick="selectAiDifficulty('hard', this)">Hard</button>
                <button data-difficulty="aggressive" onclick="selectAiDifficulty('aggressive', this)">Aggressive</button>
                <button data-difficulty="defensive" onclick="selectAiDifficulty('defensive', this)">Defensive</button>
            </div>
        </div>
        <button id="ai-start-btn" onclick="startAiGame()" disabled>Play</button>
    </div>
</section>

<section id="local-options-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Local Multiplayer</h2>
        <div class="option-group">
            <label>Select Grid Size</label>
            <div class="option-buttons" id="local-grid-options">
                <button data-size="4" onclick="selectLocalGrid(4, this)">4x4</button>
                <button data-size="5" onclick="selectLocalGrid(5, this)">5x5</button>
                <button data-size="6" onclick="selectLocalGrid(6, this)">6x6</button>
                <button data-size="7" onclick="selectLocalGrid(7, this)">7x7</button>
                <button data-size="8" onclick="selectLocalGrid(8, this)">8x8</button>
                <button data-size="9" onclick="selectLocalGrid(9, this)">9x9</button>
            </div>
        </div>
        <button id="local-start-btn" onclick="startLocalGame()" disabled>Play</button>
    </div>
</section>

<section id="local-player-names-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Enter Player Names</h2>
        <div class="input-group">
            <label for="player1-name">Player 1 (üîµ)</label>
            <input type="text" id="player1-name" placeholder="Enter name" oninput="checkLocalNames()"/>
        </div>
        <div class="input-group">
            <label for="player2-name">Player 2 (üî¥)</label>
            <input type="text" id="player2-name" placeholder="Enter name" oninput="checkLocalNames()"/>
        </div>
        <button id="local-start-game-btn" onclick="startLocalGameWithNames()" disabled>Start Game</button>
        <button class="back-btn" onclick="showLocalOptions()">Back</button>
    </div>
</section>

<!-- Invite Friend Screens -->
<section id="multi-setup-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Invite Friend</h2>
        <div class="game-modes">
            <button class="mode-btn" onclick="showCreateRoom()">‚ûï Create Room</button>
            <button class="mode-btn" onclick="showJoinRoom()">‚û°Ô∏è Join Room</button>
        </div>
        <button class="back-btn" onclick="goHome()">Back</button>
    </div>
</section>

<section id="create-room-options-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Create Room</h2>

        <div class="input-group">
            <label for="my-player-name">My Name (üîµ)</label>
            <input type="text" id="my-player-name" placeholder="Enter your name" oninput="checkCreateRoomOptions()"/>
        </div>
        
        <div class="option-group">
            <label>Select Match Fee</label>
            <div class="option-buttons" id="coin-select-options">
                <button data-fee="0" onclick="selectCoinFee(0, this)">Free</button>
                <button data-fee="500" onclick="selectCoinFee(500, this)">500</button>
                <button data-fee="1000" onclick="selectCoinFee(1000, this)">1000</button>
                <button data-fee="3000" onclick="selectCoinFee(3000, this)">3000</button>
                <button data-fee="6000" onclick="selectCoinFee(6000, this)">6000</button>
                <button data-fee="10000" onclick="selectCoinFee(10000, this)">10000</button>
            </div>
        </div>

        <div class="option-group">
            <label>Select Grid Size</label>
            <div class="option-buttons" id="multi-grid-options">
                <button data-size="6" onclick="selectMultiGrid(6, this)">6x6</button>
                <button data-size="7" onclick="selectMultiGrid(7, this)">7x7</button>
                <button data-size="8" onclick="selectMultiGrid(8, this)">8x8</button>
                <button data-size="9" onclick="selectMultiGrid(9, this)">9x9</button>
            </div>
        </div>
        
        <button id="create-room-btn" class="custom-action-btn" onclick="createRoom()" disabled>Create Room Code</button>
        <button class="back-btn" onclick="showMultiplayerSetup()">Back</button>
    </div>
</section>

<section id="join-room-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Join Room</h2>
        <div class="input-group">
            <label for="joiner-player-name">My Name (üî¥)</label>
            <input type="text" id="joiner-player-name" placeholder="Enter your name" oninput="checkJoinRoomInput()"/>
        </div>
        <div class="input-group">
            <label for="room-code-input">Enter Room Code</label>
            <input type="text" id="room-code-input" placeholder="e.g. XYZ123" oninput="checkJoinRoomInput()"/>
            <small id="room-code-error" style="color: #ff6b6b; margin-top: 5px;"></small>
        </div>
        <button id="join-room-final-btn" class="custom-action-btn" onclick="joinRoom()" disabled>Join Room</button>
        <button class="back-btn" onclick="showMultiplayerSetup()">Back</button>
    </div>
</section>

<section id="waiting-lobby-screen" class="game-section">
    <div class="container game-options-screen lobby-content">
        <h2>Waiting for Opponent...</h2>
        <div class="room-code-display">Room Code: <span id="lobby-room-code"></span></div>
        <button id="share-whatsapp-btn" class="mode-btn" style="background: #25D366; width: 80%;" onclick="shareRoomCode()">Share on WhatsApp</button>
        
        <div class="player-slot creator ready" id="lobby-p1-slot">
            <span class="emoji">üîµ</span>
            <span id="lobby-p1-name">Creator</span>
            <span class="status">(Ready)</span>
        </div>
        
        <div class="player-slot" id="lobby-p2-slot">
            <span class="emoji">üî¥</span>
            <span id="lobby-p2-name">Waiting...</span>
            <span class="status">(Not Joined)</span>
        </div>

        <button id="waiting-lobby-play-btn" class="custom-action-btn" onclick="startGameConfirmation()">Play</button>
        <button class="back-btn" onclick="leaveLobby()">Exit Lobby</button>
    </div>
</section>

<section id="game-confirmation-screen" class="game-section">
    <div class="container game-options-screen">
        <h2>Game Confirmation</h2>
        <p><strong>Grid Size:</strong> <span id="confirm-grid-size"></span></p>
        <p><strong>Match Fee:</strong> <span id="confirm-match-fee"></span> Coins (Pot: <span id="confirm-pot"></span> Coins)</p>
        <p>Coins will be deducted upon clicking 'Start Game'.</p>
        <button id="confirm-start-btn" onclick="startMultiplayerGame()" class="custom-action-btn" style="background: linear-gradient(180deg, #66bb6a, #388e3c);">Start Game</button>
        <button class="back-btn" onclick="goHome()">Cancel</button>
    </div>
</section>

<!-- Game Screens -->
<section id="ai-game" class="game-section">
  <div class="game-screen-top-bar">
    <div class="player-logo-container">
        <div class="turn-indicator" id="ai-player-indicator"></div>
        <span class="emoji">üîµ</span>
        <span class="player-score">You: <span id="ai-playerScore">0</span></span>
    </div>
    <div class="player-logo-container">
        <div class="turn-indicator" id="ai-ai-indicator"></div>
        <span class="emoji">ü§ñ</span>
        <span class="player-score">AI: <span id="ai-aiScore">0</span></span>
    </div>
  </div>
  <canvas id="ai-canvas"></canvas>
  <div class="game-screen-bottom-bar">
    <button onclick="goHomeFromAi()">üè† Home</button>
    <button onclick="restartAiGame()">üîÅ Restart</button>
    <button id="hint-btn" onclick="showHint()">üí° Hint (2)</button>
  </div>
  <div id="ai-popup">
    <h2 id="ai-winnerText"></h2>
    <p id="ai-finalScoreText"></p>
    <button onclick="restartAiGame()">Play Again</button>
  </div>
</section>

<section id="local-game" class="game-section">
    <div class="game-screen-top-bar">
        <div class="player-logo-container">
            <div class="turn-indicator" id="local-p1-indicator"></div>
            <span class="emoji">üîµ</span>
            <span class="player-score" id="local-p1-name">P1: <span id="local-playerScore">0</span></span>
        </div>
        <div class="player-logo-container">
            <div class="turn-indicator" id="local-p2-indicator"></div>
            <span class="emoji">üî¥</span>
            <span class="player-score" id="local-p2-name">P2: <span id="local-aiScore">0</span></span>
        </div>
    </div>
    <canvas id="local-canvas"></canvas>
    <div class="game-screen-bottom-bar">
      <button class="back-btn" onclick="goHomeFromLocal()">Back</button>
      <button onclick="restartLocalGame()">üîÅ Restart</button>
    </div>
    <div id="local-popup">
        <h2 id="local-resultText"></h2>
        <button onclick="restartLocalGame()">Play Again</button>
    </div>
</section>

<section id="multiplayer-game" class="game-section">
    <div class="game-screen-top-bar">
        <div class="player-logo-container">
            <div class="turn-indicator" id="multi-p1-indicator"></div>
            <span class="emoji">üîµ</span>
            <span class="player-score" id="multi-p1-name-score">
                <span id="multi-p1-name">P1</span>: <span id="multi-p1-score">0</span>
            </span>
        </div>
        <div id="turn-timer-text">25</div>
        <div class="player-logo-container">
            <div class="turn-indicator" id="multi-p2-indicator"></div>
            <span class="emoji">üî¥</span>
            <span class="player-score" id="multi-p2-name-score">
                <span id="multi-p2-name">P2</span>: <span id="multi-p2-score">0</span>
            </span>
        </div>
        <div id="chat-icon" onclick="showChatQuickPanel()">üí¨</div>
    </div>
    
    <canvas id="multi-canvas"></canvas>
    
    <div class="game-screen-bottom-bar">
        <!-- Removed Exit button as requested -->
    </div>
    
    <div id="multi-popup">
        <h2 id="multi-resultText"></h2>
        <p id="multi-pot-info"></p>
        <button class="back-btn" onclick="goHome()">Exit to Home</button>
    </div>
</section>

<canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; pointer-events: none; width: 100%; height: 100%; z-index: 100;"></canvas>
<div class="coming-soon-popup" id="coming-soon-popup" onclick="hideComingSoon()">
  Coming Soon!
</div>
<div class="consecutive-box-popup" id="consecutiveBoxPopup"></div>
<canvas id="sparkle-canvas"></canvas>
<div class="global-coming-soon-popup" id="global-coming-soon-popup">
  <h2>üåç Global Multiplayer is Coming Soon!</h2>
  <p>
    ‡§Ø‡§π ‡§´‡§º‡•Ä‡§ö‡§∞ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§è‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ ‡§ú‡§¨ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§™‡•ç‡§≤‡•á‡§Ø‡§∞ ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¨‡§¢‡§º‡•á‡§ó‡•Ä‡•§
    ‡§§‡§¨ ‡§§‡§ï, ‡§∏‡§ø‡§ï‡•ç‡§ï‡•á ‡§ï‡§Æ‡§æ‡§§‡•á ‡§∞‡§π‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§ï‡§∞‡§§‡•á ‡§∞‡§π‡•á‡§Ç! üí™üí∞
    <br>
    <br>
    This feature will be added in an update once our active player count grows.
    Until then, keep collecting coins and strengthening your profile! üí™üí∞
  </p>
  <button onclick="hideGlobalComingSoon()">Awesome!</button>
</div>

<div id="quick-chat-panel">
    <div class="chat-header">
        <h3>Quick Chat & Emoji</h3>
        <button class="chat-close-btn" onclick="closeChatPanel()">‚ùå</button>
    </div>
    <div class="option-buttons chat-emoji-buttons" style="margin-bottom: 15px;">
        <button onclick="sendChat('üòÑ')">üòÑ</button>
        <button onclick="sendChat('üéâ')">üéâ</button>
        <button onclick="sendChat('üëè')">üëè</button>
        <button onclick="sendChat('üò°')">üò°</button>
        <button onclick="sendChat('ü§Ø')">ü§Ø</button>
        <button onclick="sendChat('üòÇ')">üòÇ</button>
    </div>
    <div class="chat-quick-buttons">
        <button onclick="sendChat('Good luck!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Good luck!</button>
        <button onclick="sendChat('Nice move!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Nice move!</button>
        <button onclick="sendChat('Oh no!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Oh no!</button>
        <button onclick="sendChat('Haha!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Haha!</button>
        <button onclick="sendChat('Let's go!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Let's go!</button>
        <button onclick="sendChat('Good game!')" class="mode-btn" style="padding: 8px; font-size: 16px;">Good game!</button>
    </div>
</div>

<script>
  // ====================================================================================
  // Global Variables and Audio Setup
  // ====================================================================================
  const backgroundMusic = document.getElementById('background-music');
  const intenseMusic = document.getElementById('intense-music');
  const lineSound = document.getElementById('lineSound');
  const boxSound = document.getElementById('boxSound');
  const winSound = document.getElementById('winSound');
  const tapSound = document.getElementById('tap-sound');
  const coinSound = document.getElementById('coin-sound');

  let isAudioPlaying = false;
  let isIntenseMusicPlaying = false;
  
  // Game state variables for AI game
  let aiGameGridSize = 0;
  let aiGameDifficulty = '';
  let aiHorLines, aiVerLines, aiBoxes;
  let aiPlayerTurn = true;
  let aiScores = { player: 0, ai: 0 };
  let isAiGameOver = false;
  let hintMove = null;
  let hintTimeout;
  let aiHintsUsed = 0;
  let isFirstTimeHint = false;
  let lastAiLine = null;

  // Game state variables for Local game
  let localGameGridSize = 0;
  let localPlayer1Name = "Player 1";
  let localPlayer2Name = "Player 2";
  const LOCAL_PLAYER1 = 1;
  const LOCAL_PLAYER2 = 2;
  let localHorizontalLines, localVerticalLines, localBoxes;
  let localCurrentPlayer = LOCAL_PLAYER1;
  let localPlayerScore = 0, localAiScore = 0;
  let isLocalGameOver = false;
  let lastLocalLine = null;

  // Settings variables
  let settings = {
    playerName: "Player",
    country: "in",
    matchHistory: {
        ai: { total: 0, win: 0, loss: 0, draw: 0 },
        local: { total: 0, win: 0, loss: 0, draw: 0 },
        global: { total: 0, win: 0, loss: 0, draw: 0 },
    },
    musicEnabled: true,
    sfxEnabled: true,
    dotColor: "#FFFFFF",
    lineColor: "#1976d2",
    boxFillColor: "#1976d2",
    gameBackground: "none",
    extraTurnEnabled: true,
    animationSpeed: "normal"
  };
  
  let rewardState = {
      dailyClaimed: false,
      ad350Claimed: false,
      ad500Claimed: false,
      ad700Claimed: false,
  };
  
  const BACKGROUND_IMAGES = {
      none: "",
      stars: "url('https://www.transparenttextures.com/patterns/stardust.png')",
      wood: "url('https://www.transparenttextures.com/patterns/wood-pattern.png')",
      circuit: "url('https://www.transparenttextures.com/patterns/clean-gray-paper.png')",
      galaxy: "url('https://www.transparenttextures.com/patterns/navy-blue.png')"
  };

  const sparkleCanvas = document.getElementById("sparkle-canvas");
  const sparkleCtx = sparkleCanvas ? sparkleCanvas.getContext("2d") : null;
  let sparkles = [];
  
  let hintPopupActive = false;

  // ====================================================================================
  // Invite Friend Multiplayer Variables
  // ====================================================================================
  const MULTI_PLAYER1 = 1; // Creator (Blue)
  const MULTI_PLAYER2 = 2; // Joiner (Red)
  let myPlayerId = 0; 
  let myPlayerName = "";
  let multiRoomCode = null;
  let multiGridSize = 0;
  let multiMatchFee = 0;
  let multiHorizontalLines, multiVerticalLines, multiBoxes;
  let multiCurrentPlayer = MULTI_PLAYER1;
  let multiP1Score = 0, multiP2Score = 0;
  let isMultiGameOver = false;
  let multiTurnTimerInterval = null;
  let multiTimerDuration = 25; // seconds
  let multiTimeRemaining = multiTimerDuration;
  let lastMultiLine = null;

  // Canvas & Context for Multiplayer (M_ for Multi)
  const multiCanvas = document.getElementById("multi-canvas");
  const multiCtx = multiCanvas ? multiCanvas.getContext("2d") : null;
  let M_ROWS, M_COLS, M_CELL_SIZE, M_PADDING;

  // ====================================================================================
  // UI Navigation and Home Screen Logic
  // ====================================================================================
  function showScreen(screenId) {
    document.querySelectorAll('.game-section').forEach(section => {
      section.classList.remove('active');
    });
    const screenElement = document.getElementById(screenId);
    if (screenElement) {
        screenElement.classList.add('active');
    }
  }

  function goHome() {
    playSound(tapSound);
    showScreen('home-screen');
    updateGameBackground(settings.gameBackground);
    clearHint();
    stopIntenseMusic();
  }
  
  function goHomeFromAi() {
    playSound(tapSound);
    isAiGameOver = true;
    showScreen('home-screen');
    updateGameBackground(settings.gameBackground);
    clearHint();
    stopIntenseMusic();
  }

  function goHomeFromLocal() {
    playSound(tapSound);
    isLocalGameOver = true;
    showScreen('home-screen');
    updateGameBackground(settings.gameBackground);
    stopIntenseMusic();
  }
  
  function showFreeRewardsPopup() {
      playSound(tapSound);
      const popup = document.getElementById('free-rewards-popup');
      if (popup) {
          popup.style.display = 'flex';
          checkRewardStatus();
      }
  }
  
  function hideFreeRewardsPopup() {
      playSound(tapSound);
      const popup = document.getElementById('free-rewards-popup');
      if (popup) {
          popup.style.display = 'none';
      }
  }
  
  function checkRewardStatus() {
      const lastClaim = localStorage.getItem('lastClaimDate');
      const today = new Date().toDateString();
      rewardState.dailyClaimed = lastClaim === today;
      
      rewardState.ad350Claimed = localStorage.getItem('ad350Claimed') === 'true';
      rewardState.ad500Claimed = localStorage.getItem('ad500Claimed') === 'true';
      rewardState.ad700Claimed = localStorage.getItem('ad700Claimed') === 'true';

      const dailyBtn = document.getElementById('dailyRewardClaimBtn');
      if (dailyBtn) {
          dailyBtn.disabled = rewardState.dailyClaimed;
          dailyBtn.textContent = rewardState.dailyClaimed ? 'Claimed' : 'Claim';
      }

      const ad350Btn = document.getElementById('adReward350Btn');
      if (ad350Btn) {
          ad350Btn.disabled = rewardState.ad350Claimed;
          ad350Btn.textContent = rewardState.ad350Claimed ? 'Claimed' : 'Watch Ads';
      }

      const ad500Btn = document.getElementById('adReward500Btn');
      if (ad500Btn) {
          ad500Btn.disabled = !rewardState.ad350Claimed || rewardState.ad500Claimed;
          ad500Btn.textContent = rewardState.ad500Claimed ? 'Claimed' : 'Watch Ads';
      }
      
      const ad700Btn = document.getElementById('adReward700Btn');
      if (ad700Btn) {
          ad700Btn.disabled = !rewardState.ad500Claimed || rewardState.ad700Claimed;
          ad700Btn.textContent = rewardState.ad700Claimed ? 'Claimed' : 'Watch Ads';
      }
  }
  
  function claimDailyReward() {
      playSound(coinSound);
      const dailyBtn = document.getElementById('dailyRewardClaimBtn');
      const coinCountElement = document.getElementById("coinCount");
      let coins = parseInt(localStorage.getItem('coinCount') || 0);
      coins += 100;
      if (coinCountElement) {
        coinCountElement.innerText = coins;
      }
      localStorage.setItem('lastClaimDate', new Date().toDateString());
      localStorage.setItem('coinCount', coins);
      dailyBtn.textContent = 'Claimed';
      dailyBtn.disabled = true;
      checkRewardStatus();
  }
  
  function watchAdAndClaim(reward, key) {
      playSound(tapSound);
      const btn = document.getElementById(`adReward${key}Btn`);
      if (btn) {
          btn.textContent = 'Watching Ad...';
          btn.disabled = true;
          // Placeholder for ad logic
          setTimeout(() => {
              playSound(coinSound);
              let coins = parseInt(localStorage.getItem('coinCount') || 0);
              coins += reward;
              localStorage.setItem('coinCount', coins);
              const coinCountElement = document.getElementById("coinCount");
              if (coinCountElement) {
                  coinCountElement.innerText = coins;
              }
              localStorage.setItem(`ad${key}Claimed`, 'true');
              btn.textContent = 'Claimed';
              checkRewardStatus();
          }, 2000); // Simulate ad watching for 2 seconds
      }
  }

  function playSound(audio) {
    if (settings.sfxEnabled) {
      audio.currentTime = 0;
      audio.play();
    }
  }

  function toggleAudio() {
    const audioControls = document.getElementById('audio-controls');
    if (isAudioPlaying) {
      backgroundMusic.pause();
      intenseMusic.pause();
      if (audioControls) audioControls.innerText = 'üîá';
    } else {
      if (isIntenseMusicPlaying) {
        intenseMusic.play();
      } else {
        backgroundMusic.play();
      }
      if (audioControls) audioControls.innerText = 'üîä';
    }
    isAudioPlaying = !isAudioPlaying;
  }

  function toggleBackgroundMusic() {
    const musicToggle = document.getElementById('musicToggle');
    if (!musicToggle) return;
    const isChecked = musicToggle.checked;
    settings.musicEnabled = isChecked;
    if (isChecked) {
      if (isIntenseMusicPlaying) {
        intenseMusic.play();
        backgroundMusic.pause();
      } else {
        backgroundMusic.play();
        intenseMusic.pause();
      }
    } else {
      backgroundMusic.pause();
      intenseMusic.pause();
    }
    saveSettings();
  }
  
  function openSettingsScreen() {
    playSound(tapSound);
    showScreen("settings-screen");
    loadSettings();
  }

  function closeSettingsScreen() {
    playSound(tapSound);
    saveSettings();
    showScreen("home-screen");
  }
  
  function contactDeveloper() {
    const subject = encodeURIComponent("Help Request for Dots N Boxes Game");
    const body = encodeURIComponent(`Hello Developer,
I need help with the following issue:
[Please describe your issue here in detail]

My Player Name: ${settings.playerName}
Game Version: 1.3.0

Thank you.`);
    window.location.href = `mailto:dotsnboxess@gmail.com?subject=${subject}&body=${body}`;
  }

  function loadSettings() {
    const storedSettings = JSON.parse(localStorage.getItem("gameSettings")) || settings;
    settings = { ...settings, ...storedSettings };

    const playerNameInput = document.getElementById("playerName");
    if (playerNameInput) playerNameInput.value = settings.playerName;
    const userNameElement = document.getElementById("userName");
    if (userNameElement) userNameElement.innerText = settings.playerName;
    const countrySelect = document.getElementById("country");
    if (countrySelect) countrySelect.value = settings.country;
    
    document.getElementById("matchTotal-ai").innerText = settings.matchHistory.ai.total;
    document.getElementById("matchWin-ai").innerText = settings.matchHistory.ai.win;
    document.getElementById("matchLoss-ai").innerText = settings.matchHistory.ai.loss;
    document.getElementById("matchDraw-ai").innerText = settings.matchHistory.ai.draw;
    document.getElementById("matchTotal-local").innerText = settings.matchHistory.local.total;
    document.getElementById("matchWin-local").innerText = settings.matchHistory.local.win;
    document.getElementById("matchLoss-local").innerText = settings.matchHistory.local.loss;
    document.getElementById("matchDraw-local").innerText = settings.matchHistory.local.draw;
    document.getElementById("matchTotal-global").innerText = settings.matchHistory.global.total;
    document.getElementById("matchWin-global").innerText = settings.matchHistory.global.win;
    document.getElementById("matchLoss-global").innerText = settings.matchHistory.global.loss;
    document.getElementById("matchDraw-global").innerText = settings.matchHistory.global.draw;

    const musicToggle = document.getElementById("musicToggle");
    if (musicToggle) musicToggle.checked = settings.musicEnabled;
    const sfxToggle = document.getElementById("sfxToggle");
    if (sfxToggle) sfxToggle.checked = settings.sfxEnabled;
    const dotColorSelect = document.getElementById("dotColor");
    if (dotColorSelect) dotColorSelect.value = settings.dotColor;
    const lineColorInput = document.getElementById("lineColor");
    if (lineColorInput) lineColorInput.value = settings.lineColor;
    const boxFillColorSelect = document.getElementById("boxFillColor");
    if (boxFillColorSelect) boxFillColorSelect.value = settings.boxFillColor;
    const gameBackgroundSelect = document.getElementById("gameBackground");
    if (gameBackgroundSelect) gameBackgroundSelect.value = settings.gameBackground;
    const extraTurnToggle = document.getElementById("extraTurnToggle");
    if (extraTurnToggle) extraTurnToggle.checked = settings.extraTurnEnabled;
    const animationSpeedSelect = document.getElementById("animationSpeed");
    if (animationSpeedSelect) animationSpeedSelect.value = settings.animationSpeed;
    
    if (settings.musicEnabled) {
      backgroundMusic.play();
    } else {
      backgroundMusic.pause();
    }
  }
  
  function saveSettings() {
    const playerNameInput = document.getElementById("playerName");
    settings.playerName = playerNameInput ? playerNameInput.value || "Player" : "Player";
    const countrySelect = document.getElementById("country");
    settings.country = countrySelect ? countrySelect.value : "in";
    const musicToggle = document.getElementById("musicToggle");
    settings.musicEnabled = musicToggle ? musicToggle.checked : true;
    const sfxToggle = document.getElementById("sfxToggle");
    settings.sfxEnabled = sfxToggle ? sfxToggle.checked : true;
    const dotColorSelect = document.getElementById("dotColor");
    settings.dotColor = dotColorSelect ? dotColorSelect.value : "#FFFFFF";
    const lineColorInput = document.getElementById("lineColor");
    settings.lineColor = lineColorInput ? lineColorInput.value : "#1976d2";
    const boxFillColorSelect = document.getElementById("boxFillColor");
    settings.boxFillColor = boxFillColorSelect ? boxFillColorSelect.value : "#1976d2";
    const gameBackgroundSelect = document.getElementById("gameBackground");
    settings.gameBackground = gameBackgroundSelect ? gameBackgroundSelect.value : "none";
    const extraTurnToggle = document.getElementById("extraTurnToggle");
    settings.extraTurnEnabled = extraTurnToggle ? extraTurnToggle.checked : true;
    const animationSpeedSelect = document.getElementById("animationSpeed");
    settings.animationSpeed = animationSpeedSelect ? animationSpeedSelect.value : "normal";
    localStorage.setItem("gameSettings", JSON.stringify(settings));
    const userNameElement = document.getElementById("userName");
    if (userNameElement) userNameElement.innerText = settings.playerName;
  }
  
  function updateDotColor() {
    settings.dotColor = document.getElementById("dotColor").value;
    saveSettings();
    drawAllCanvases();
  }
  
  function updateLineColor() {
    settings.lineColor = document.getElementById("lineColor").value;
    saveSettings();
    drawAllCanvases();
  }
  
  function updateBoxFillColor() {
    settings.boxFillColor = document.getElementById("boxFillColor").value;
    saveSettings();
    drawAllCanvases();
  }
  
  function drawAllCanvases() {
      if(document.getElementById('ai-game').classList.contains('active')) drawAiBoard();
      if(document.getElementById('local-game').classList.contains('active')) drawLocal();
      if(document.getElementById('multiplayer-game').classList.contains('active')) drawMulti();
  }

  function updateGameBackground(bgId) {
      const bgElement = document.getElementById('game-play-background');
      if (bgElement) {
        bgElement.style.backgroundImage = BACKGROUND_IMAGES[bgId];
        settings.gameBackground = bgId;
        saveSettings();
      }
  }

  function uploadProfilePic(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const userPhoto = document.getElementById("userPhoto");
        if (userPhoto) userPhoto.src = e.target.result;
        localStorage.setItem("userPhoto", e.target.result);
      };
      reader.readAsDataURL(file);
    }
  }

  function showComingSoon(message) {
    playSound(tapSound);
    const popup = document.getElementById('coming-soon-popup');
    if (popup) {
        popup.textContent = message;
        popup.style.display = 'block';
    }
  }
  function hideComingSoon() {
    const popup = document.getElementById('coming-soon-popup');
    if (popup) {
        popup.style.display = 'none';
    }
  }

  function showGlobalComingSoon() {
    playSound(tapSound);
    const popup = document.getElementById('global-coming-soon-popup');
    if (popup) {
        popup.style.display = 'block';
    }
  }

  function hideGlobalComingSoon() {
    const popup = document.getElementById('global-coming-soon-popup');
    if (popup) {
        popup.style.display = 'none';
    }
  }
  
  function showConsecutiveBoxPopup(count) {
    const popup = document.getElementById('consecutiveBoxPopup');
    if (!popup) return;
    let message = "";
    let colorClass = "";
    if (count >= 5) {
        message = "Fantastic!";
        colorClass = "fantastic";
    } else if (count >= 3) {
        message = "Great!";
        colorClass = "great";
    } else if (count >= 2) {
        message = "Good Job!";
        colorClass = "good-job";
    }

    if (message) {
        popup.textContent = message;
        popup.className = `consecutive-box-popup show ${colorClass}`;
        setTimeout(() => {
            popup.classList.remove('show');
        }, 2000);
    }
  }

  // ====================================================================================
  // Game Options and Initialization
  // ====================================================================================
  function showAiOptions() {
    playSound(tapSound);
    showScreen('ai-options-screen');
    aiGameGridSize = 0;
    aiGameDifficulty = '';
    const aiStartBtn = document.getElementById('ai-start-btn');
    if (aiStartBtn) aiStartBtn.disabled = true;
    document.querySelectorAll('#ai-options-screen .option-buttons button').forEach(btn => btn.classList.remove('selected'));
  }

  function selectAiGrid(size, button) {
    playSound(tapSound);
    aiGameGridSize = size;
    document.querySelectorAll('#ai-grid-options button').forEach(btn => btn.classList.remove('selected'));
    if (button) button.classList.add('selected');
    checkAiOptionsComplete();
  }

  function selectAiDifficulty(difficulty, button) {
    playSound(tapSound);
    aiGameDifficulty = difficulty;
    document.querySelectorAll('#ai-difficulty-options button').forEach(btn => btn.classList.remove('selected'));
    if (button) button.classList.add('selected');
    checkAiOptionsComplete();
  }

  function checkAiOptionsComplete() {
    const aiStartBtn = document.getElementById('ai-start-btn');
    if (aiStartBtn) {
        aiStartBtn.disabled = !(aiGameGridSize > 0 && aiGameDifficulty);
    }
  }

  function startAiGame() {
    playSound(tapSound);
    initAiGame(aiGameGridSize);
    showScreen('ai-game');
    updateGameBackground(settings.gameBackground);
    checkAndSwitchMusic(0, aiGameGridSize);
    
    // Check if it's the player's first time playing AI game
    if (!localStorage.getItem('hasPlayedAiGame')) {
        setTimeout(() => {
            showFirstTimeHintPopup();
        }, 2000);
        localStorage.setItem('hasPlayedAiGame', 'true');
    }
  }

  function showLocalOptions() {
    playSound(tapSound);
    showScreen('local-options-screen');
    localGameGridSize = 0;
    const localStartBtn = document.getElementById('local-start-btn');
    if (localStartBtn) localStartBtn.disabled = true;
    document.querySelectorAll('#local-grid-options button').forEach(btn => btn.classList.remove('selected'));
  }

  function selectLocalGrid(size, button) {
    playSound(tapSound);
    localGameGridSize = size;
    document.querySelectorAll('#local-grid-options button').forEach(btn => btn.classList.remove('selected'));
    if (button) button.classList.add('selected');
    const localStartBtn = document.getElementById('local-start-btn');
    if (localStartBtn) {
        localStartBtn.disabled = !(localGameGridSize > 0);
    }
  }
  
  function startLocalGame() {
    playSound(tapSound);
    if (localGameGridSize > 0) {
        showScreen('local-player-names-screen');
    }
  }
  
  function checkLocalNames() {
      const p1Name = document.getElementById('player1-name').value;
      const p2Name = document.getElementById('player2-name').value;
      const startBtn = document.getElementById('local-start-game-btn');
      startBtn.disabled = !p1Name || !p2Name;
  }
  
  function startLocalGameWithNames() {
      playSound(tapSound);
      localPlayer1Name = document.getElementById('player1-name').value || "Player 1";
      localPlayer2Name = document.getElementById('player2-name').value || "Player 2";
      initLocalGame(localGameGridSize);
      showScreen('local-game');
      updateGameBackground(settings.gameBackground);
      checkAndSwitchMusic(0, localGameGridSize);
  }

  // ====================================================================================
  // Invite Friend Multiplayer Logic
  // ====================================================================================
  function showMultiplayerSetup() {
    playSound(tapSound);
    showScreen('multi-setup-screen');
  }

  function showCreateRoom() {
    playSound(tapSound);
    multiGridSize = 0;
    multiMatchFee = 0;
    document.getElementById('my-player-name').value = "Player" + Math.floor(Math.random() * 100);
    document.querySelectorAll('#coin-select-options button').forEach(btn => btn.classList.remove('selected'));
    document.querySelectorAll('#multi-grid-options button').forEach(btn => btn.classList.remove('selected'));
    checkCreateRoomOptions();
    showScreen('create-room-options-screen');
  }

  function showJoinRoom() {
    playSound(tapSound);
    document.getElementById('room-code-input').value = "";
    document.getElementById('room-code-error').textContent = "";
    document.getElementById('joiner-player-name').value = "Player" + Math.floor(Math.random() * 100);
    checkJoinRoomInput();
    showScreen('join-room-screen');
  }

  function selectCoinFee(fee, button) {
    playSound(tapSound);
    multiMatchFee = fee;
    document.querySelectorAll('#coin-select-options button').forEach(btn => btn.classList.remove('selected'));
    if (button) button.classList.add('selected');
    checkCreateRoomOptions();
  }
  
  function selectMultiGrid(size, button) {
    playSound(tapSound);
    multiGridSize = size;
    document.querySelectorAll('#multi-grid-options button').forEach(btn => btn.classList.remove('selected'));
    if (button) button.classList.add('selected');
    checkCreateRoomOptions();
  }

  function checkCreateRoomOptions() {
    const pName = document.getElementById('my-player-name').value;
    const createBtn = document.getElementById('create-room-btn');
    createBtn.disabled = !(pName && multiGridSize > 0 && multiMatchFee >= 0);
    myPlayerName = pName;
  }
  
  function checkJoinRoomInput() {
    const pName = document.getElementById('joiner-player-name').value;
    const code = document.getElementById('room-code-input').value.trim();
    const joinBtn = document.getElementById('join-room-final-btn');
    joinBtn.disabled = !code || !pName;
    myPlayerName = pName;
  }
  
  function generateRoomCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  function createRoom() {
    playSound(tapSound);
    myPlayerId = MULTI_PLAYER1;
    multiRoomCode = generateRoomCode();
    
    const initialGameState = {
      gridSize: multiGridSize,
      matchFee: multiMatchFee,
      pot: multiMatchFee * 2,
      status: 'WAITING', 
      gameStarted: false, 
      turn: MULTI_PLAYER1,
      lastMove: null,
      timer: multiTimerDuration,
      
      p1Name: myPlayerName,
      p1Score: 0,
      
      p2Name: 'Waiting...',
      p2Score: 0,

      hLines: Array(multiGridSize).fill(0).map(() => Array(multiGridSize - 1).fill(0)),
      vLines: Array(multiGridSize - 1).fill(0).map(() => Array(multiGridSize).fill(0)),
      boxes: Array(multiGridSize - 1).fill(0).map(() => Array(multiGridSize - 1).fill(0)),
      
      chat: { 
        lastMessage: { content: null, time: 0, sender: null }
      }
    };

    firebaseSet(firebaseRef(database, `rooms/${multiRoomCode}`), initialGameState)
      .then(() => {
        showLobby(multiRoomCode);
        listenToRoomChanges(multiRoomCode);
      })
      .catch(error => {
        alert("Failed to create room: " + error.message);
        goHome();
      });
  }

  function joinRoom() {
    playSound(tapSound);
    myPlayerId = MULTI_PLAYER2;
    const code = document.getElementById('room-code-input').value.trim().toUpperCase();

    firebaseGet(firebaseRef(database, `rooms/${code}`))
      .then(snapshot => {
        const roomData = snapshot.val();
        if (!roomData) {
          document.getElementById('room-code-error').textContent = "Invalid Room Code.";
          return;
        }
        if (roomData.p2Name !== 'Waiting...') {
          document.getElementById('room-code-error').textContent = "Room is full or game started.";
          return;
        }
        
        multiRoomCode = code;
        multiGridSize = roomData.gridSize;
        multiMatchFee = roomData.matchFee;
        
        return firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), {
          p2Name: myPlayerName
        });
      })
      .then(() => {
        if (multiRoomCode) {
          showLobby(multiRoomCode);
          listenToRoomChanges(multiRoomCode);
        }
      })
      .catch(error => {
        if (!multiRoomCode) return;
        alert("Failed to join room: " + error.message);
        goHome();
      });
  }

  function leaveLobby() {
    playSound(tapSound);
    if (multiRoomCode && myPlayerId === MULTI_PLAYER2) {
      firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), { p2Name: 'Waiting...' });
    } else if (multiRoomCode && myPlayerId === MULTI_PLAYER1) {
      firebaseRemove(firebaseRef(database, `rooms/${multiRoomCode}`));
    }
    goHome();
  }

  function showLobby(code) {
    document.getElementById('lobby-room-code').textContent = code;
    
    const playBtn = document.getElementById('waiting-lobby-play-btn');
    if (myPlayerId === MULTI_PLAYER1) {
      playBtn.style.display = 'inline-block';
      playBtn.disabled = true; 
    } else {
      playBtn.style.display = 'none';
    }
    
    showScreen('waiting-lobby-screen');
  }
  
  function shareRoomCode() {
    const code = multiRoomCode;
    const fee = multiMatchFee;
    const message = `Join my Dots N Boxes game! Room Code: *${code}*. Match Fee: ${fee} coins. Enter the code in the 'Join Room' screen.`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }

  function listenToRoomChanges(code) {
    const roomRef = firebaseRef(database, `rooms/${code}`);

    firebaseOnValue(roomRef, (snapshot) => {
      const roomData = snapshot.val();
      if (!roomData) {
        firebaseOff(roomRef);
        if (document.getElementById('multiplayer-game').classList.contains('active') || document.getElementById('waiting-lobby-screen').classList.contains('active')) {
          alert("The room was closed by the creator. Returning home.");
        }
        goHome();
        return;
      }
      
      if (roomData.status === 'WAITING') {
        document.getElementById('lobby-p1-name').textContent = `${roomData.p1Name} ${myPlayerId === MULTI_PLAYER1 ? '(You)' : ''}`;
        document.getElementById('lobby-p2-name').textContent = roomData.p2Name;
        const p2Slot = document.getElementById('lobby-p2-slot');
        const playBtn = document.getElementById('waiting-lobby-play-btn');
        
        if (roomData.p2Name && roomData.p2Name !== 'Waiting...') {
          p2Slot.classList.add('ready');
          p2Slot.querySelector('.status').textContent = '(Joined)';
          if (myPlayerId === MULTI_PLAYER1) playBtn.disabled = false;
        } else {
          p2Slot.classList.remove('ready');
          p2Slot.querySelector('.status').textContent = '(Not Joined)';
          if (myPlayerId === MULTI_PLAYER1) playBtn.disabled = true;
        }

        if(roomData.gameStarted) {
          startGameConfirmation(roomData);
        }

      } else if (roomData.status === 'PLAYING') {
        if (!document.getElementById('multiplayer-game').classList.contains('active')) {
          initMultiGame(roomData);
          showScreen('multiplayer-game');
        } else {
          syncGameState(roomData);
        }
      } else if (roomData.status === 'FINISHED') {
        syncGameState(roomData);
        checkMultiWin();
      }

      if (roomData.chat && roomData.chat.lastMessage && roomData.chat.lastMessage.content && roomData.chat.lastMessage.time > (Date.now() - 3000)) {
        const message = roomData.chat.lastMessage;
        if (message.sender !== myPlayerId) {
          displayIncomingChat(message.content);
        }
      }
    });
  }

  function startGameConfirmation(roomData = null) {
    playSound(tapSound);
    
    if (myPlayerId === MULTI_PLAYER1 && !roomData) {
      firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), { gameStarted: true });
    }
    
    const data = roomData || { gridSize: multiGridSize, matchFee: multiMatchFee };
    document.getElementById('confirm-grid-size').textContent = `${data.gridSize}x${data.gridSize}`;
    document.getElementById('confirm-match-fee').textContent = data.matchFee;
    document.getElementById('confirm-pot').textContent = data.matchFee * 2;
    showScreen('game-confirmation-screen');
  }

  function startMultiplayerGame() {
    playSound(tapSound);
    
    firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), {
      status: 'PLAYING',
      gameStarted: false 
    });
  }
  
  function initMultiGame(roomData) {
    if (!multiCanvas || !multiCtx) return;

    M_ROWS = roomData.gridSize;
    M_COLS = roomData.gridSize;
    const canvasSize = Math.min(window.innerWidth - 40, 500);
    multiCanvas.width = canvasSize;
    multiCanvas.height = canvasSize;
    M_PADDING = canvasSize * 0.08;
    M_CELL_SIZE = (canvasSize - 2 * M_PADDING) / (M_COLS - 1);

    multiHorizontalLines = roomData.hLines;
    multiVerticalLines = roomData.vLines;
    multiBoxes = roomData.boxes;
    
    multiCurrentPlayer = roomData.turn;
    multiP1Score = roomData.p1Score;
    multiP2Score = roomData.p2Score;
    isMultiGameOver = false;
    
    document.getElementById('multi-p1-name').textContent = roomData.p1Name;
    document.getElementById('multi-p2-name').textContent = roomData.p2Name;
    
    updateMultiScores();
    updateMultiTurnIndicator();
    drawMulti();
    
    multiCanvas.removeEventListener("click", handleMultiClick);
    multiCanvas.addEventListener("click", handleMultiClick);
    
    startMultiTimer(roomData.timer);
  }
  
  function syncGameState(roomData) {
    multiHorizontalLines = roomData.hLines;
    multiVerticalLines = roomData.vLines;
    multiBoxes = roomData.boxes;
    multiCurrentPlayer = roomData.turn;
    multiP1Score = roomData.p1Score;
    multiP2Score = roomData.p2Score;
    
    if (roomData.lastMove) {
      const { r, c, type, completedBoxes } = roomData.lastMove;
      lastMultiLine = { r, c, type };
      if (multiCurrentPlayer !== myPlayerId) { 
        if (completedBoxes > 1) {
          showConsecutiveBoxPopup(completedBoxes);
        }
        if (completedBoxes > 0) playSound(boxSound);
        else playSound(lineSound);
      }
    } else {
      lastMultiLine = null;
    }

    updateMultiScores();
    updateMultiTurnIndicator();
    drawMulti();
    
    if (multiTurnTimerInterval) clearInterval(multiTurnTimerInterval);
    startMultiTimer(roomData.timer);
  }

  function handleMultiClick(e) {
    if (isMultiGameOver || multiCurrentPlayer !== myPlayerId) return;

    const rect = multiCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    let moveMade = false;
    let r = -1, c = -1, type = '';
    const dotRadius = M_CELL_SIZE * 0.15; 
    const lineTolerance = M_CELL_SIZE * 0.3; 

    // 1. Check for Horizontal lines
    for (let row = 0; row < M_ROWS; row++) {
      for (let col = 0; col < M_COLS - 1; col++) {
        const dotY = row * M_CELL_SIZE + M_PADDING;
        const dotX1 = col * M_CELL_SIZE + M_PADDING;
        const dotX2 = (col + 1) * M_CELL_SIZE + M_PADDING;
        
        const distanceToLine = Math.abs(y - dotY);
        const isWithinXBounds = x >= dotX1 + dotRadius && x <= dotX2 - dotRadius;
        
        if (distanceToLine <= lineTolerance && isWithinXBounds && multiHorizontalLines[row][col] === 0) {
          multiHorizontalLines[row][col] = myPlayerId;
          r = row; c = col; type = "H";
          moveMade = true;
          break;
        }
      }
      if (moveMade) break;
    }

    // 2. Check for Vertical lines
    if (!moveMade) {
      for (let row = 0; row < M_ROWS - 1; row++) {
        for (let col = 0; col < M_COLS; col++) {
          const dotX = col * M_CELL_SIZE + M_PADDING;
          const dotY1 = row * M_CELL_SIZE + M_PADDING;
          const dotY2 = (row + 1) * M_CELL_SIZE + M_PADDING;
          
          const distanceToLine = Math.abs(x - dotX);
          const isWithinYBounds = y >= dotY1 + dotRadius && y <= dotY2 - dotRadius;
          
          if (distanceToLine <= lineTolerance && isWithinYBounds && multiVerticalLines[row][col] === 0) {
            multiVerticalLines[row][col] = myPlayerId;
            r = row; c = col; type = "V";
            moveMade = true;
            break;
          }
        }
        if (moveMade) break;
      }
    }

    if (moveMade) {
      processMultiMove(r, c, type);
    }
  }
  
  function processMultiMove(r, c, type) {
    let completedBoxes = 0;
    
    let tempP1Score = multiP1Score;
    let tempP2Score = multiP2Score;
    let originalBoxes = JSON.parse(JSON.stringify(multiBoxes));
    
    if (type === "H") {
      if (r > 0 && checkMultiBoxForClaim(r - 1, c, multiHorizontalLines, multiVerticalLines)) {
        completedBoxes += claimMultiBoxTemp(r - 1, c, myPlayerId, tempP1Score, tempP2Score, originalBoxes);
      }
      if (r < M_ROWS - 1 && checkMultiBoxForClaim(r, c, multiHorizontalLines, multiVerticalLines)) {
        completedBoxes += claimMultiBoxTemp(r, c, myPlayerId, tempP1Score, tempP2Score, originalBoxes);
      }
    } else { 
      if (c > 0 && checkMultiBoxForClaim(r, c - 1, multiHorizontalLines, multiVerticalLines)) {
        completedBoxes += claimMultiBoxTemp(r, c - 1, myPlayerId, tempP1Score, tempP2Score, originalBoxes);
      }
      if (c < M_COLS - 1 && checkMultiBoxForClaim(r, c, multiHorizontalLines, multiVerticalLines)) {
        completedBoxes += claimMultiBoxTemp(r, c, myPlayerId, tempP1Score, tempP2Score, originalBoxes);
      }
    }

    const nextPlayer = (completedBoxes === 0 || !settings.extraTurnEnabled) 
      ? (multiCurrentPlayer === MULTI_PLAYER1 ? MULTI_PLAYER2 : MULTI_PLAYER1) 
      : multiCurrentPlayer;

    const update = {
      hLines: multiHorizontalLines,
      vLines: multiVerticalLines,
      boxes: originalBoxes,
      turn: nextPlayer,
      p1Score: (myPlayerId === MULTI_PLAYER1) ? tempP1Score + completedBoxes : tempP1Score,
      p2Score: (myPlayerId === MULTI_PLAYER2) ? tempP2Score + completedBoxes : tempP2Score,
      lastMove: { r, c, type, completedBoxes },
      timer: multiTimerDuration 
    };
    
    multiCurrentPlayer = nextPlayer;
    multiP1Score = update.p1Score;
    multiP2Score = update.p2Score;
    multiBoxes = originalBoxes;
    
    playSound(lineSound);
    if(completedBoxes > 0) playSound(boxSound);
    if(completedBoxes > 1) showConsecutiveBoxPopup(completedBoxes);
    
    firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), update);
    
    const total = (M_ROWS - 1) * (M_COLS - 1);
    if (multiP1Score + multiP2Score === total) {
      firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), { status: 'FINISHED' });
    }
  }

  function checkMultiBoxForClaim(r, c, hLines, vLines) {
    if (r < 0 || r >= M_ROWS - 1 || c < 0 || c >= M_COLS - 1) return false;
    return hLines[r][c] &&
           hLines[r + 1][c] &&
           vLines[r][c] &&
           vLines[r][c + 1];
  }

  function claimMultiBoxTemp(r, c, playerId, p1ScoreRef, p2ScoreRef, boxesRef) {
    if (boxesRef[r][c] === 0) {
      boxesRef[r][c] = playerId;
      return 1;
    }
    return 0;
  }

  function updateMultiScores() {
    const p1ScoreEl = document.getElementById("multi-p1-score");
    const p2ScoreEl = document.getElementById("multi-p2-score");
    
    if (p1ScoreEl) p1ScoreEl.textContent = multiP1Score;
    if (p2ScoreEl) p2ScoreEl.textContent = multiP2Score;
  }
  
  function drawMulti() {
    if (!multiCtx) return;
    multiCtx.clearRect(0, 0, multiCanvas.width, multiCanvas.height);
    drawMultiDots();
    drawMultiLines();
    drawMultiBoxes();
  }

  function drawMultiDots() {
    if (!multiCtx) return;
    for (let r = 0; r < M_ROWS; r++) {
      for (let c = 0; c < M_COLS; c++) {
        const x = M_PADDING + c * M_CELL_SIZE;
        const y = M_PADDING + r * M_CELL_SIZE;
        multiCtx.fillStyle = settings.dotColor;
        multiCtx.beginPath();
        multiCtx.arc(x, y, M_CELL_SIZE * 0.08, 0, Math.PI * 2);
        multiCtx.fill();
      }
    }
  }

  function drawMultiLines() {
    if (!multiCtx) return;
    multiCtx.lineWidth = M_CELL_SIZE * 0.15;
    multiCtx.lineCap = 'round';
    multiCtx.shadowColor = 'rgba(0,0,0,0.3)';
    multiCtx.shadowBlur = 4;
    multiCtx.shadowOffsetX = 1;
    multiCtx.shadowOffsetY = 1;

    for (let r = 0; r < M_ROWS; r++) {
      for (let c = 0; c < M_COLS - 1; c++) {
        const val = multiHorizontalLines[r][c];
        if (val) {
          multiCtx.strokeStyle = (lastMultiLine && lastMultiLine.type === 'H' && lastMultiLine.r === r && lastMultiLine.c === c) ? '#FFA500' : (val === MULTI_PLAYER1 ? settings.lineColor : "#d32f2f");
          multiCtx.beginPath();
          multiCtx.moveTo(M_PADDING + c * M_CELL_SIZE, M_PADDING + r * M_CELL_SIZE);
          multiCtx.lineTo(M_PADDING + (c + 1) * M_CELL_SIZE, M_PADDING + r * M_CELL_SIZE);
          multiCtx.stroke();
        }
      }
    }
    for (let r = 0; r < M_ROWS - 1; r++) {
      for (let c = 0; c < M_COLS; c++) {
        const val = multiVerticalLines[r][c];
        if (val) {
          multiCtx.strokeStyle = (lastMultiLine && lastMultiLine.type === 'V' && lastMultiLine.r === r && lastMultiLine.c === c) ? '#FFA500' : (val === MULTI_PLAYER1 ? settings.lineColor : "#d32f2f");
          multiCtx.beginPath();
          multiCtx.moveTo(M_PADDING + c * M_CELL_SIZE, M_PADDING + r * M_CELL_SIZE);
          multiCtx.lineTo(M_PADDING + c * M_CELL_SIZE, M_PADDING + (r + 1) * M_CELL_SIZE);
          multiCtx.stroke();
        }
      }
    }
    multiCtx.shadowBlur = 0;
  }

  function drawMultiBoxes() {
    if (!multiCtx) return;
    for (let r = 0; r < M_ROWS - 1; r++) {
      for (let c = 0; c < M_COLS - 1; c++) {
        if (multiBoxes[r][c]) {
          multiCtx.fillStyle = multiBoxes[r][c] === MULTI_PLAYER1 ? hexToRgba(settings.boxFillColor, 0.3) : "rgba(211, 47, 47, 0.3)";
          multiCtx.fillRect(M_PADDING + c * M_CELL_SIZE, M_PADDING + r * M_CELL_SIZE, M_CELL_SIZE, M_CELL_SIZE);
          multiCtx.font = `${M_CELL_SIZE * 0.4}px Roboto`;
          multiCtx.fillStyle = multiBoxes[r][c] === MULTI_PLAYER1 ? settings.boxFillColor : "#d32f2f";
          multiCtx.textAlign = 'center';
          multiCtx.textBaseline = 'middle';
          multiCtx.fillText(multiBoxes[r][c] === MULTI_PLAYER1 ? "üîµ" : "üî¥", M_PADDING + c * M_CELL_SIZE + M_CELL_SIZE / 2, M_PADDING + r * M_CELL_SIZE + M_CELL_SIZE / 2);
        }
      }
    }
  }

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function updateMultiTurnIndicator() {
    const p1Indicator = document.getElementById('multi-p1-indicator');
    const p2Indicator = document.getElementById('multi-p2-indicator');
    if(p1Indicator && p2Indicator) {
      p1Indicator.classList.toggle('active', multiCurrentPlayer === MULTI_PLAYER1);
      p1Indicator.classList.toggle('pulse', multiCurrentPlayer === MULTI_PLAYER1);
      p2Indicator.classList.toggle('active', multiCurrentPlayer === MULTI_PLAYER2);
      p2Indicator.classList.toggle('pulse', multiCurrentPlayer === MULTI_PLAYER2);
    }
  }

  function checkMultiWin() {
    const total = (M_ROWS - 1) * (M_COLS - 1);
    if (multiP1Score + multiP2Score === total && !isMultiGameOver) {
      isMultiGameOver = true;
      playSound(winSound);
      
      const p1Name = document.getElementById('multi-p1-name').textContent;
      const p2Name = document.getElementById('multi-p2-name').textContent;
      
      let msg = "";
      let winnerId = 0;
      if (multiP1Score > multiP2Score) {
        msg = `üéâ ${p1Name} Wins!`;
        winnerId = MULTI_PLAYER1;
      } else if (multiP2Score > multiP1Score) {
        msg = `üéâ ${p2Name} Wins!`;
        winnerId = MULTI_PLAYER2;
      } else {
        msg = "ü§ù It's a Tie!";
      }

      document.getElementById("multi-resultText").textContent = msg;
      document.getElementById("multi-pot-info").textContent = `Score: üîµ ${multiP1Score} - üî¥ ${multiP2Score}. Pot: ${multiMatchFee * 2} coins.`;
      
      // The single button in the popup will always be 'Exit to Home'
      const resultButton = document.querySelector('#multi-popup .back-btn');
      
      // Set the visual state for the winner/loser text
      if (resultButton) {
        if (winnerId === myPlayerId) {
          document.getElementById("multi-resultText").style.color = '#4caf50'; // Green for win
        } else if (winnerId === 0) {
          document.getElementById("multi-resultText").style.color = '#ffc107'; // Yellow for tie
        } else {
          document.getElementById("multi-resultText").style.color = '#d32f2f'; // Red for lose
        }
      }
      
      document.getElementById("multi-popup").style.display = "block";
    }
  }
  
  // ====================================================================================
  // TURN TIMER LOGIC 
  // ====================================================================================
  
  function startMultiTimer(initialTime) {
    if (multiTurnTimerInterval) clearInterval(multiTurnTimerInterval);
    
    multiTimeRemaining = initialTime;
    const timerText = document.getElementById('turn-timer-text');
    
    const updateTimerDisplay = () => {
      if (timerText) {
        timerText.textContent = multiTimeRemaining;
        if (multiTimeRemaining <= 5) {
          timerText.style.color = '#f44336'; 
        } else if (multiTimeRemaining <= 10) {
          timerText.style.color = '#ffc107'; 
        } else {
          timerText.style.color = '#ffffff'; 
        }
      }
    };

    updateTimerDisplay();

    multiTurnTimerInterval = setInterval(() => {
      multiTimeRemaining--;
      
      if (multiTimeRemaining < 0) {
        clearInterval(multiTurnTimerInterval);
        if (multiCurrentPlayer === myPlayerId && !isMultiGameOver) {
          const nextPlayer = multiCurrentPlayer === MULTI_PLAYER1 ? MULTI_PLAYER2 : MULTI_PLAYER1;
          firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}`), {
            turn: nextPlayer,
            timer: multiTimerDuration 
          });
        }
        return;
      }
      
      updateTimerDisplay();
      
    }, 1000);
  }
  
  // ====================================================================================
  // CHAT & EMOJI LOGIC
  // ====================================================================================

  function showChatQuickPanel() {
    playSound(tapSound);
    const panel = document.getElementById('quick-chat-panel');
    panel.classList.add('active');
  }
  
  function closeChatPanel() {
    playSound(tapSound);
    const panel = document.getElementById('quick-chat-panel');
    panel.classList.remove('active');
  }

  function sendChat(content) {
    playSound(tapSound);
    if (!multiRoomCode) return;
    
    const isEmoji = content.length <= 2; 

    const message = {
      content: content,
      time: Date.now(),
      sender: myPlayerId
    };
    
    firebaseUpdate(firebaseRef(database, `rooms/${multiRoomCode}/chat/lastMessage`), message);
    
    if (isEmoji) {
      displayIncomingChat(content); 
    }

    closeChatPanel();
  }

  function displayIncomingChat(content) {
    const isEmoji = content.length <= 2;
    const popup = document.createElement('div');
    
    if (isEmoji) {
      popup.className = 'emoji-reaction-popup';
      popup.textContent = content;
    } else {
      popup.className = 'quick-chat-popup';
      popup.textContent = content;
    }

    document.body.appendChild(popup);
    
    setTimeout(() => {
      popup.remove();
    }, 4000);
  }

  // ====================================================================================
  // Music Logic
  // ====================================================================================
  function checkAndSwitchMusic(currentBoxes, gridSize) {
    if (!settings.musicEnabled) {
      backgroundMusic.pause();
      intenseMusic.pause();
      return;
    }
    const totalBoxes = (gridSize - 1) * (gridSize - 1);
    const intenseThreshold = 0.75;
    const isCloseToEnd = totalBoxes > 0 && currentBoxes / totalBoxes >= intenseThreshold;

    if (isCloseToEnd && !isIntenseMusicPlaying) {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
      intenseMusic.play();
      isIntenseMusicPlaying = true;
    } else if (!isCloseToEnd && isIntenseMusicPlaying) {
      intenseMusic.pause();
      intenseMusic.currentTime = 0;
      backgroundMusic.play();
      isIntenseMusicPlaying = false;
    }
  }
  
  function stopIntenseMusic() {
    if (isIntenseMusicPlaying) {
      intenseMusic.pause();
      intenseMusic.currentTime = 0;
      backgroundMusic.play();
      isIntenseMusicPlaying = false;
    }
  }

  // ====================================================================================
  // AI Game Logic
  // ====================================================================================
  const aiCanvas = document.getElementById("ai-canvas");
  const aiCtx = aiCanvas ? aiCanvas.getContext("2d") : null;
  let AI_ROWS, AI_COLS, AI_CELL_SIZE, AI_PADDING;

  function initAiGame(gridSize) {
    if (!aiCanvas || !aiCtx) return;

    AI_ROWS = gridSize;
    AI_COLS = gridSize;
    const canvasSize = Math.min(window.innerWidth - 40, 500);
    aiCanvas.width = canvasSize;
    aiCanvas.height = canvasSize;
    AI_PADDING = canvasSize * 0.08;
    AI_CELL_SIZE = (canvasSize - 2 * AI_PADDING) / (AI_COLS - 1);
    
    aiHorLines = Array.from({ length: AI_ROWS }, () => Array(AI_COLS - 1).fill(null));
    aiVerLines = Array.from({ length: AI_ROWS - 1 }, () => Array(AI_COLS).fill(null));
    aiBoxes = Array.from({ length: AI_ROWS - 1 }, () => Array(AI_COLS - 1).fill(null));
    aiPlayerTurn = true;
    aiScores = { player: 0, ai: 0 };
    isAiGameOver = false;
    aiHintsUsed = 0;
    isFirstTimeHint = !localStorage.getItem('hasUsedFirstTimeHint');
    lastAiLine = null;
    updateAiHintButton();
    updateAiScores();
    drawAiBoard();
    updateAiTurnIndicator();
    closeAiPopup();
    aiCanvas.removeEventListener("click", handleAiClick);
    aiCanvas.addEventListener("click", handleAiClick);
    clearHint();
    stopIntenseMusic();
  }

  function drawAiBoard() {
    if (!aiCtx) return;
    aiCtx.clearRect(0, 0, aiCanvas.width, aiCanvas.height);
    drawAiDots();
    drawAiLines();
    drawAiBoxes();
    if(hintMove) {
      drawHintLine(hintMove, isFirstTimeHint);
    }
  }
  
  function drawAiDots() {
    if (!aiCtx) return;
    for (let r = 0; r < AI_ROWS; r++) {
      for (let c = 0; c < AI_COLS; c++) {
        const x = c * AI_CELL_SIZE + AI_PADDING;
        const y = r * AI_CELL_SIZE + AI_PADDING;
        let grad = aiCtx.createRadialGradient(x, y, 1, x, y, AI_CELL_SIZE * 0.08);
        grad.addColorStop(0, settings.dotColor); grad.addColorStop(0.8, settings.dotColor); grad.addColorStop(1, settings.dotColor);
        aiCtx.fillStyle = grad;
        aiCtx.beginPath();
        aiCtx.arc(x, y, AI_CELL_SIZE * 0.08, 0, Math.PI * 2);
        aiCtx.fill();
      }
    }
  }

  function drawAiLines() {
    if (!aiCtx) return;
    aiCtx.lineWidth = AI_CELL_SIZE * 0.15;
    aiCtx.lineCap = 'round';
    aiCtx.shadowColor = 'rgba(0,0,0,0.3)';
    aiCtx.shadowBlur = 4;
    aiCtx.shadowOffsetX = 1;
    aiCtx.shadowOffsetY = 1;

    for (let r = 0; r < AI_ROWS; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        const val = aiHorLines[r][c];
        if (val) {
          aiCtx.strokeStyle = (lastAiLine && lastAiLine.type === 'h' && lastAiLine.r === r && lastAiLine.c === c) ? '#FFA500' : (val === "player" ? settings.lineColor : "#d32f2f");
          aiCtx.beginPath();
          aiCtx.moveTo(c * AI_CELL_SIZE + AI_PADDING, r * AI_CELL_SIZE + AI_PADDING);
          aiCtx.lineTo((c + 1) * AI_CELL_SIZE + AI_PADDING, r * AI_CELL_SIZE + AI_PADDING);
          aiCtx.stroke();
        }
      }
    }
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS; c++) {
        const val = aiVerLines[r][c];
        if (val) {
          aiCtx.strokeStyle = (lastAiLine && lastAiLine.type === 'v' && lastAiLine.r === r && lastAiLine.c === c) ? '#FFA500' : (val === "player" ? settings.lineColor : "#d32f2f");
          aiCtx.beginPath();
          aiCtx.moveTo(c * AI_CELL_SIZE + AI_PADDING, r * AI_CELL_SIZE + AI_PADDING);
          aiCtx.lineTo(c * AI_CELL_SIZE + AI_PADDING, (r + 1) * AI_CELL_SIZE + AI_PADDING);
          aiCtx.stroke();
        }
      }
    }
    aiCtx.shadowBlur = 0;
  }
  
  function drawAiBoxes() {
    if (!aiCtx) return;
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        const owner = aiBoxes[r][c];
        if (owner) {
          aiCtx.fillStyle = owner === "player" ? hexToRgba(settings.boxFillColor, 0.3) : "rgba(211, 47, 47, 0.3)";
          aiCtx.fillRect(c * AI_CELL_SIZE + AI_PADDING, r * AI_CELL_SIZE + AI_PADDING, AI_CELL_SIZE, AI_CELL_SIZE);
          aiCtx.font = `${AI_CELL_SIZE * 0.4}px Roboto`;
          aiCtx.fillStyle = owner === "player" ? settings.boxFillColor : "#d32f2f";
          aiCtx.textAlign = 'center';
          aiCtx.textBaseline = 'middle';
          aiCtx.fillText(owner === "player" ? "üîµ" : "ü§ñ", c * AI_CELL_SIZE + AI_PADDING + AI_CELL_SIZE / 2, r * AI_CELL_SIZE + AI_PADDING + AI_CELL_SIZE / 2);
        }
      }
    }
  }

  function handleAiClick(e) {
    if (!aiPlayerTurn || isAiGameOver) return;
    const rect = aiCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    let moveMade = false;
    let r = -1, c = -1, type = '';
    
    if (isFirstTimeHint && hintMove) {
      if (isClickOnHintLine(x, y, hintMove)) {
        r = hintMove.r;
        c = hintMove.c;
        type = hintMove.type;
        if (type === 'h') aiHorLines[r][c] = "player";
        else aiVerLines[r][c] = "player";
        playSound(lineSound);
        moveMade = true;
        clearFirstTimeHintPopup();
        isFirstTimeHint = false;
        localStorage.setItem('hasUsedFirstTimeHint', 'true');
      }
    }

    if (!moveMade) {
      const touchTolerance = AI_CELL_SIZE * 0.2;

      for (let row = 0; row < AI_ROWS; row++) {
        for (let col = 0; col < AI_COLS - 1; col++) {
          const lineX = col * AI_CELL_SIZE + AI_PADDING;
          const lineY = row * AI_CELL_SIZE + AI_PADDING;
          if (y > lineY - touchTolerance && y < lineY + touchTolerance && x > lineX && x < lineX + AI_CELL_SIZE) {
            if (!aiHorLines[row][col]) {
              r = row; c = col; type = 'h';
              aiHorLines[r][c] = "player";
              playSound(lineSound);
              moveMade = true;
              break;
            }
          }
        }
        if (moveMade) break;
      }

      if (!moveMade) {
        for (let row = 0; row < AI_ROWS - 1; row++) {
          for (let col = 0; col < AI_COLS; col++) {
            const lineX = col * AI_CELL_SIZE + AI_PADDING;
            const lineY = row * AI_CELL_SIZE + AI_PADDING;
            if (x > lineX - touchTolerance && x < lineX + touchTolerance && y > lineY && y < lineY + AI_CELL_SIZE) {
              if (!aiVerLines[row][col]) {
                r = row; c = col; type = 'v';
                aiVerLines[r][c] = "player";
                playSound(lineSound);
                moveMade = true;
                break;
              }
            }
          }
          if (moveMade) break;
        }
      }
    }
    
    if(moveMade) {
      lastAiLine = { r, c, type };
      clearHint();
      const consecutiveBoxes = checkAiBoxCompletion("player");
      drawAiBoard();
      updateAiScores();
      checkAndSwitchMusic(aiScores.player + aiScores.ai, aiGameGridSize);
      checkAiGameOver();
      
      if(consecutiveBoxes > 1) {
        showConsecutiveBoxPopup(consecutiveBoxes);
      }
      if(consecutiveBoxes > 0) {
        launchSparks(
          e.clientX - rect.left, 
          e.clientY - rect.top, 
          aiCanvas
        );
      }
      
      if (!isAiGameOver && (!consecutiveBoxes || !settings.extraTurnEnabled)) {
        aiPlayerTurn = false;
        updateAiTurnIndicator();
        setTimeout(aiMove, getAnimationSpeed());
      }
    }
  }
  
  function checkAiBoxCompletion(player) {
    let scoredBoxes = 0;
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!aiBoxes[r][c] &&
            aiHorLines[r][c] && aiHorLines[r + 1][c] &&
            aiVerLines[r][c] && aiVerLines[r][c + 1]) {
          aiBoxes[r][c] = player;
          aiScores[player]++;
          scoredBoxes++;
        }
      }
    }
    if (scoredBoxes > 0) {
      playSound(boxSound);
    }
    return scoredBoxes;
  }
  
  function getAnimationSpeed() {
    switch (settings.animationSpeed) {
      case 'slow': return 1000;
      case 'fast': return 250;
      default: return 500;
    }
  }

  function updateAiScores() {
    const playerScoreElement = document.getElementById("ai-playerScore");
    if (playerScoreElement) playerScoreElement.textContent = aiScores.player;
    const aiScoreElement = document.getElementById("ai-aiScore");
    if (aiScoreElement) aiScoreElement.textContent = aiScores.ai;
  }

  function updateAiTurnIndicator() {
    const playerIndicator = document.getElementById('ai-player-indicator');
    const aiIndicator = document.getElementById('ai-ai-indicator');
    if (playerIndicator) {
      playerIndicator.classList.toggle('active', aiPlayerTurn);
      playerIndicator.classList.toggle('pulse', aiPlayerTurn);
    }
    if (aiIndicator) {
      aiIndicator.classList.toggle('active', !aiPlayerTurn);
      aiIndicator.classList.toggle('pulse', !aiPlayerTurn);
    }
  }

  function aiMove() {
    if (isAiGameOver) return;
    
    let move;
    if (aiGameDifficulty === 'aggressive' || aiGameDifficulty === 'defensive') {
      move = findUnbeatableAiMove();
    } else {
      move = getBestAiMove();
    }

    if (!move) {
      aiPlayerTurn = true;
      updateAiTurnIndicator();
      return;
    }
    
    let lineX, lineY;
    if (move.type === "h") {
      aiHorLines[move.r][move.c] = "ai";
      lineX = (move.c + 0.5) * AI_CELL_SIZE + AI_PADDING;
      lineY = move.r * AI_CELL_SIZE + AI_PADDING;
    }
    else {
      aiVerLines[move.r][move.c] = "ai";
      lineX = move.c * AI_CELL_SIZE + AI_PADDING;
      lineY = (move.r + 0.5) * AI_CELL_SIZE + AI_PADDING;
    }

    lastAiLine = { r: move.r, c: move.c, type: move.type };
    playSound(lineSound);
    const consecutiveBoxes = checkAiBoxCompletion("ai");
    drawAiBoard();
    updateAiScores();
    checkAndSwitchMusic(aiScores.player + aiScores.ai, aiGameGridSize);
    checkAiGameOver();
    
    if(consecutiveBoxes > 0) {
      launchSparks(lineX, lineY, aiCanvas);
    }

    if (!isAiGameOver && consecutiveBoxes > 0 && settings.extraTurnEnabled) {
      setTimeout(aiMove, getAnimationSpeed());
    } else {
      aiPlayerTurn = true;
      updateAiTurnIndicator();
    }
  }
  
  function findUnbeatableAiMove() {
    const availableMoves = getAllAvailableAiLines();
    if (availableMoves.length === 0) return null;

    for (const move of availableMoves) {
      const { tempHor, tempVer } = simulateMove(move);
      const completedBoxes = countCompletedBoxes(tempHor, tempVer);
      if (completedBoxes > 0) {
        return move;
      }
    }

    if (aiGameDifficulty === 'aggressive' || aiGameDifficulty === 'defensive') {
      const opponentCompletionMove = getMoveToPreventPlayerBox();
      if (opponentCompletionMove) {
        return opponentCompletionMove;
      }
    }

    if (aiGameDifficulty === 'aggressive') {
      const bestAggressiveMove = findAggressiveMove();
      if (bestAggressiveMove) return bestAggressiveMove;

      const safeMoves = availableMoves.filter(m => !isMoveDangerous(m));
      if (safeMoves.length > 0) {
        return safeMoves[Math.floor(Math.random() * safeMoves.length)];
      }
      return findShortestChainMove();
    }

    if (aiGameDifficulty === 'defensive') {
      const bestDefensiveMove = findDefensiveMove();
      if (bestDefensiveMove) return bestDefensiveMove;

      return findShortestChainMove();
    }

    return getBestAiMove();
  }

  function findAggressiveMove() {
    const moves = getAllAvailableAiLines();
    for (const move of moves) {
      const { tempHor, tempVer } = simulateMove(move);
      if (countBoxesWithThreeSides(tempHor, tempVer) >= 2) {
        return move;
      }
    }

    for (const move of moves) {
      if (isMoveDangerous(move)) {
        return move;
      }
    }
    return null;
  }

  function findDefensiveMove() {
    const availableMoves = getAllAvailableAiLines();
    
    const nonThreateningMoves = availableMoves.filter(m => {
      const { tempHor, tempVer } = simulateMove(m, 'player');
      return countCompletedBoxes(tempHor, tempVer) === 0;
    });

    if (nonThreateningMoves.length > 0) {
      return nonThreateningMoves[Math.floor(Math.random() * nonThreateningMoves.length)];
    }

    return null;
  }
  
  function findShortestChainMove() {
    const availableMoves = getAllAvailableAiLines();
    if (availableMoves.length === 0) return null;

    let bestMove = null;
    let minBoxesToOpponent = Infinity;
    
    for (const move of availableMoves) {
      const { tempHor, tempVer } = simulateMove(move);
      let boxesToOpponent = 0;
      let lastMove = move;
      let tempHorClone = JSON.parse(JSON.stringify(tempHor));
      let tempVerClone = JSON.parse(JSON.stringify(tempVer));
      let tempBoxesClone = JSON.parse(JSON.stringify(aiBoxes));

      while(true) {
        let newlyCompletedBoxes = 0;
        if (lastMove.type === 'h') {
          if (lastMove.r > 0 && isBoxComplete(lastMove.r - 1, lastMove.c, tempHorClone, tempVerClone) && !tempBoxesClone[lastMove.r - 1][lastMove.c]) {
            newlyCompletedBoxes++; tempBoxesClone[lastMove.r - 1][lastMove.c] = 'ai';
          }
          if (lastMove.r < AI_ROWS - 1 && isBoxComplete(lastMove.r, lastMove.c, tempHorClone, tempVerClone) && !tempBoxesClone[lastMove.r][lastMove.c]) {
            newlyCompletedBoxes++; tempBoxesClone[lastMove.r][lastMove.c] = 'ai';
          }
        } else {
          if (lastMove.c > 0 && isBoxComplete(lastMove.r, lastMove.c - 1, tempHorClone, tempVerClone) && !tempBoxesClone[lastMove.r][lastMove.c - 1]) {
            newlyCompletedBoxes++; tempBoxesClone[lastMove.r][lastMove.c - 1] = 'ai';
          }
          if (lastMove.c < AI_COLS - 1 && isBoxComplete(lastMove.r, lastMove.c, tempHorClone, tempVerClone) && !tempBoxesClone[lastMove.r][lastMove.c]) {
            newlyCompletedBoxes++; tempBoxesClone[lastMove.r][lastMove.c] = 'ai';
          }
        }

        if (newlyCompletedBoxes === 0) {
          let opponentMove = findOpponentBoxMove(tempHorClone, tempVerClone, tempBoxesClone);
          if (opponentMove) {
            boxesToOpponent++;
            if(opponentMove.type === 'h') tempHorClone[opponentMove.r][opponentMove.c] = 'player';
            else tempVerClone[opponentMove.r][opponentMove.c] = 'player';
            lastMove = opponentMove;
          } else {
            break;
          }
        } else {
          let nextAIMove = findBoxMove(tempHorClone, tempVerClone, tempBoxesClone);
          if (nextAIMove) {
            lastMove = nextAIMove;
          } else {
            let opponentMove = findOpponentBoxMove(tempHorClone, tempVerClone, tempBoxesClone);
            if (opponentMove) {
              boxesToOpponent++;
            }
            break;
          }
        }
      }

      if (boxesToOpponent < minBoxesToOpponent) {
        minBoxesToOpponent = boxesToOpponent;
        bestMove = move;
      }
    }

    return bestMove;
  }
  
  function findOpponentBoxMove(horLines, verLines, boxes) {
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!boxes[r][c]) {
          let sides = 0;
          if (horLines[r][c]) sides++;
          if (horLines[r+1][c]) sides++;
          if (verLines[r][c]) sides++;
          if (verLines[r][c+1]) sides++;
          if (sides === 3) {
            if (!horLines[r][c]) return { type: 'h', r: r, c: c };
            if (!horLines[r+1][c]) return { type: 'h', r: r+1, c: c };
            if (!verLines[r][c]) return { type: 'v', r: r, c: c };
            if (!verLines[r][c+1]) return { type: 'v', r: r, c: c+1 };
          }
        }
      }
    }
    return null;
  }

  function findBoxMove(horLines, verLines, boxes) {
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!boxes[r][c]) {
          let sides = 0;
          if (horLines[r][c]) sides++;
          if (horLines[r+1][c]) sides++;
          if (verLines[r][c]) sides++;
          if (verLines[r][c+1]) sides++;
          if (sides === 3) {
            if (!horLines[r][c]) return { type: 'h', r: r, c: c };
            if (!horLines[r+1][c]) return { type: 'h', r: r+1, c: c };
            if (!verLines[r][c]) return { type: 'v', r: r, c: c };
            if (!verLines[r][c+1]) return { type: 'v', r: r, c: c+1 };
          }
        }
      }
    }
    return null;
  }
  
  function isBoxComplete(r, c, horLines, verLines) {
    if (r < 0 || r >= AI_ROWS - 1 || c < 0 || c >= AI_COLS - 1) return false;
    return horLines[r][c] && horLines[r+1][c] && verLines[r][c] && verLines[r][c+1];
  }

  // ====================================================================================
  // Basic AI Logic
  // ====================================================================================

  function getBestAiMove() {
    const completionMove = getMoveToCompleteBox();
    if (completionMove) return completionMove;

    if (aiGameDifficulty === 'hard' || aiGameDifficulty === 'defensive') {
      const defensiveMove = getMoveToPreventPlayerBox();
      if (defensiveMove) return defensiveMove;
    }
    
    const dangerousMove = getMoveToCreateThreat();
    if ((aiGameDifficulty === 'hard' || aiGameDifficulty === 'aggressive') && dangerousMove) {
      return dangerousMove;
    }
    
    const safeMoves = getAllAvailableAiLines().filter(m => !isMoveDangerous(m));
    if (safeMoves.length > 0) {
      return safeMoves[Math.floor(Math.random() * safeMoves.length)];
    }

    return getRandomAiMove();
  }

  function simulateMove(move, player = 'ai') {
    const tempHor = JSON.parse(JSON.stringify(aiHorLines));
    const tempVer = JSON.parse(JSON.stringify(aiVerLines));
    if (move.type === 'h') {
      tempHor[move.r][move.c] = player;
    } else {
      tempVer[move.r][move.c] = player;
    }
    return { tempHor, tempVer };
  }

  function countCompletedBoxes(horLines, verLines) {
    let count = 0;
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (horLines[r][c] && horLines[r + 1][c] && verLines[r][c] && verLines[r][c + 1]) {
          count++;
        }
      }
    }
    return count;
  }

  function countBoxesWithThreeSides(horLines, verLines) {
    let count = 0;
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        let sides = 0;
        if (horLines[r][c]) sides++;
        if (horLines[r + 1][c]) sides++;
        if (verLines[r][c]) sides++;
        if (verLines[r][c + 1]) sides++;
        if (sides === 3) count++;
      }
    }
    return count;
  }
  
  function getMoveToCompleteBox() {
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!aiBoxes[r][c]) {
          let sides = 0;
          if (aiHorLines[r][c]) sides++;
          if (aiHorLines[r + 1][c]) sides++;
          if (aiVerLines[r][c]) sides++;
          if (aiVerLines[r][c + 1]) sides++;
          
          if (sides === 3) {
            if (!aiHorLines[r][c]) return { type: 'h', r: r, c: c };
            if (!aiHorLines[r + 1][c]) return { type: 'h', r: r + 1, c: c };
            if (!aiVerLines[r][c]) return { type: 'v', r: r, c: c };
            if (!aiVerLines[r][c + 1]) return { type: 'v', r: r, c: c + 1 };
          }
        }
      }
    }
    return null;
  }
  
  function getMoveToPreventPlayerBox() {
    for (let r = 0; r < AI_ROWS; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!aiHorLines[r][c] && isMoveDangerous({ type: 'h', r, c })) {
          return { type: 'h', r, c };
        }
      }
    }
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS; c++) {
        if (!aiVerLines[r][c] && isMoveDangerous({ type: 'v', r, c })) {
          return { type: 'v', r, c };
        }
      }
    }
    return null;
  }
  
  function getMoveToCreateThreat() {
    const allMoves = getAllAvailableAiLines();
    for (const move of allMoves) {
      if (isMoveDangerous(move)) return move;
    }
    return null;
  }
  
  function isMoveDangerous(move) {
    if (move.type === 'h') {
      const {r, c} = move;
      if (r > 0) {
        let sides = 0;
        if (aiHorLines[r-1][c]) sides++;
        if (aiVerLines[r-1][c]) sides++;
        if (aiVerLines[r-1][c+1]) sides++;
        if (sides === 2 && !aiBoxes[r-1][c]) return true;
      }
      if (r < AI_ROWS - 1) {
        let sides = 0;
        if (aiHorLines[r+1][c]) sides++;
        if (aiVerLines[r][c]) sides++;
        if (aiVerLines[r][c+1]) sides++;
        if (sides === 2 && !aiBoxes[r][c]) return true;
      }
    } else {
      const {r, c} = move;
      if (c > 0) {
        let sides = 0;
        if (aiVerLines[r][c-1]) sides++;
        if (aiHorLines[r][c-1]) sides++;
        if (aiHorLines[r+1][c-1]) sides++;
        if (sides === 2 && !aiBoxes[r][c-1]) return true;
      }
      if (c < AI_COLS - 1) {
        let sides = 0;
        if (aiVerLines[r][c+1]) sides++;
        if (aiHorLines[r][c]) sides++;
        if (aiHorLines[r+1][c]) sides++;
        if (sides === 2 && !aiBoxes[r][c]) return true;
      }
    }
    return false;
  }
  
  function getRandomAiMove() {
    const allAvailableMoves = getAllAvailableAiLines();
    if (allAvailableMoves.length > 0) {
      return allAvailableMoves[Math.floor(Math.random() * allAvailableMoves.length)];
    }
    return null;
  }

  function getAllAvailableAiLines() {
    let lines = [];
    for (let r = 0; r < AI_ROWS; r++) {
      for (let c = 0; c < AI_COLS - 1; c++) {
        if (!aiHorLines[r][c]) lines.push({ type: "h", r, c });
      }
    }
    for (let r = 0; r < AI_ROWS - 1; r++) {
      for (let c = 0; c < AI_COLS; c++) {
        if (!aiVerLines[r][c]) lines.push({ type: "v", r, c });
      }
    }
    return lines;
  }

  function checkAiGameOver() {
    const totalBoxes = (AI_ROWS - 1) * (AI_COLS - 1);
    if (aiScores.player + aiScores.ai === totalBoxes && !isAiGameOver) {
      isAiGameOver = true;
      playSound(winSound);
      updateMatchHistory('ai');
      showAiPopup();
      launchConfetti();
      stopIntenseMusic();
    }
  }

  function updateMatchHistory(mode) {
    settings.matchHistory[mode].total++;
    if (mode === 'ai') {
      if (aiScores.player > aiScores.ai) settings.matchHistory[mode].win++;
      else if (aiScores.player < aiScores.ai) settings.matchHistory[mode].loss++;
      else settings.matchHistory[mode].draw++;
    } else if (mode === 'local') {
      if (localPlayerScore > localAiScore) settings.matchHistory[mode].win++;
      else if (localAiScore > localPlayerScore) settings.matchHistory[mode].loss++;
      else settings.matchHistory[mode].draw++;
    }
    saveSettings();
  }

  function showAiPopup() {
    const popup = document.getElementById("ai-popup");
    if (!popup) return;
    popup.style.display = "block";
    const winnerText = document.getElementById("ai-winnerText");
    if (winnerText) {
      winnerText.textContent =
      aiScores.player > aiScores.ai ? "üéâ You Win!" :
      aiScores.player < aiScores.ai ? "ü§ñ AI Wins!" :
      "ü§ù It's a Tie!";
    }
    const finalScoreText = document.getElementById("ai-finalScoreText");
    if (finalScoreText) {
      finalScoreText.textContent = `You: ${aiScores.player} | AI: ${aiScores.ai}`;
    }
  }

  function closeAiPopup() {
    const popup = document.getElementById("ai-popup");
    if (popup) popup.style.display = "none";
  }

  function restartAiGame() {
    playSound(tapSound);
    initAiGame(aiGameGridSize);
  }
  
  function updateAiHintButton() {
    const hintBtn = document.getElementById('hint-btn');
    if (hintBtn) {
      hintBtn.textContent = isFirstTimeHint ? "üí° Hint" : `üí° Hint (${2 - aiHintsUsed})`;
      hintBtn.disabled = !isFirstTimeHint && aiHintsUsed >= 2;
    }
  }

  function showHint() {
    if (!aiPlayerTurn || isAiGameOver) return;
    
    if (!isFirstTimeHint && aiHintsUsed >= 2) return;
    
    clearHint();
    const hint = findUnbeatableAiMove();
    if(hint) {
      hintMove = hint;
      drawAiBoard();
      if(!isFirstTimeHint) {
        aiHintsUsed++;
      }
      updateAiHintButton();
      hintTimeout = setTimeout(clearHint, isFirstTimeHint ? 10000 : 3000);
    }
    
    if(hintPopupActive) {
      clearFirstTimeHintPopup();
    }
  }
  
  function clearHint() {
    hintMove = null;
    if (hintTimeout) clearTimeout(hintTimeout);
    drawAiBoard();
  }
  
  function drawHintLine(move, isFirstTime) {
    if (!aiCtx) return;
    aiCtx.save();
    aiCtx.lineWidth = AI_CELL_SIZE * 0.15;
    aiCtx.strokeStyle = isFirstTime ? '#ffc107' : 'yellow';
    aiCtx.shadowColor = isFirstTime ? '#ffc107' : 'yellow';
    aiCtx.shadowBlur = 10;
    aiCtx.setLineDash(isFirstTime ? [10, 5] : [5, 5]);

    if (move.type === 'h') {
      aiCtx.beginPath();
      aiCtx.moveTo(move.c * AI_CELL_SIZE + AI_PADDING, move.r * AI_CELL_SIZE + AI_PADDING);
      aiCtx.lineTo((move.c + 1) * AI_CELL_SIZE + AI_PADDING, move.r * AI_CELL_SIZE + AI_PADDING);
      aiCtx.stroke();
    } else {
      aiCtx.beginPath();
      aiCtx.moveTo(move.c * AI_CELL_SIZE + AI_PADDING, move.r * AI_CELL_SIZE + AI_PADDING);
      aiCtx.lineTo(move.c * AI_CELL_SIZE + AI_PADDING, (move.r + 1) * AI_CELL_SIZE + AI_PADDING);
      aiCtx.stroke();
    }
    aiCtx.restore();
  }
  
  function showFirstTimeHintPopup() {
    const hintBtn = document.getElementById('hint-btn');
    if (!hintBtn || !isFirstTimeHint) return;
    
    const popup = document.createElement('div');
    popup.id = 'first-time-hint-popup';
    popup.innerHTML = `üëÜ Click here for a hint!`;
    hintBtn.appendChild(popup);
    hintPopupActive = true;
  }
  
  function clearFirstTimeHintPopup() {
    const popup = document.getElementById('first-time-hint-popup');
    if(popup) popup.remove();
    hintPopupActive = false;
  }
  
  function isClickOnHintLine(clickX, clickY, hintMove) {
    const touchTolerance = AI_CELL_SIZE * 0.2;
    const { r, c, type } = hintMove;
    
    if (type === 'h') {
      const lineX = c * AI_CELL_SIZE + AI_PADDING;
      const lineY = r * AI_CELL_SIZE + AI_PADDING;
      return (clickY > lineY - touchTolerance && clickY < lineY + touchTolerance &&
              clickX > lineX && clickX < lineX + AI_CELL_SIZE);
    } else {
      const lineX = c * AI_CELL_SIZE + AI_PADDING;
      const lineY = r * AI_CELL_SIZE + AI_PADDING;
      return (clickX > lineX - touchTolerance && clickX < lineX + touchTolerance &&
              clickY > lineY && clickY < lineY + AI_CELL_SIZE);
    }
  }

  // ====================================================================================
  // Local Multiplayer Game Logic
  // ====================================================================================
  const localCanvas = document.getElementById("local-canvas");
  const localCtx = localCanvas ? localCanvas.getContext("2d") : null;
  let LOCAL_ROWS, LOCAL_COLS, LOCAL_CELL_SIZE, LOCAL_PADDING;

  function initLocalGame(gridSize) {
    if (!localCanvas || !localCtx) return;
    LOCAL_ROWS = gridSize;
    LOCAL_COLS = gridSize;
    const canvasSize = Math.min(window.innerWidth - 40, 500);
    localCanvas.width = canvasSize;
    localCanvas.height = canvasSize;
    LOCAL_PADDING = canvasSize * 0.08;
    LOCAL_CELL_SIZE = (canvasSize - 2 * LOCAL_PADDING) / (LOCAL_COLS - 1);

    localHorizontalLines = Array.from({ length: LOCAL_ROWS }, () => Array(LOCAL_COLS - 1).fill(null));
    localVerticalLines = Array.from({ length: LOCAL_ROWS - 1 }, () => Array(LOCAL_COLS).fill(null));
    localBoxes = Array.from({ length: LOCAL_ROWS - 1 }, () => Array(LOCAL_COLS - 1).fill(null));
    localCurrentPlayer = LOCAL_PLAYER1;
    localPlayerScore = 0;
    localAiScore = 0;
    isLocalGameOver = false;
    lastLocalLine = null;
    updateLocalScores();
    drawLocal();
    updateLocalTurnIndicator();
    const popup = document.getElementById("local-popup");
    if (popup) popup.style.display = "none";
    localCanvas.removeEventListener("click", handleLocalClick);
    localCanvas.addEventListener("click", handleLocalClick);
    stopIntenseMusic();
  }

  function drawLocal() {
    if (!localCtx) return;
    localCtx.clearRect(0, 0, localCanvas.width, localCanvas.height);
    drawLocalDots();
    drawLocalLines();
    drawLocalBoxes();
  }

  function drawLocalDots() {
    if (!localCtx) return;
    for (let r = 0; r < LOCAL_ROWS; r++) {
      for (let c = 0; c < LOCAL_COLS; c++) {
        const x = LOCAL_PADDING + c * LOCAL_CELL_SIZE;
        const y = LOCAL_PADDING + r * LOCAL_CELL_SIZE;
        let grad = localCtx.createRadialGradient(x, y, 1, x, y, LOCAL_CELL_SIZE * 0.08);
        grad.addColorStop(0, settings.dotColor); grad.addColorStop(0.8, settings.dotColor); grad.addColorStop(1, settings.dotColor);
        localCtx.fillStyle = grad;
        localCtx.beginPath();
        localCtx.arc(x, y, LOCAL_CELL_SIZE * 0.08, 0, Math.PI * 2);
        localCtx.fill();
      }
    }
  }

  function drawLocalLines() {
    if (!localCtx) return;
    localCtx.lineWidth = LOCAL_CELL_SIZE * 0.15;
    localCtx.lineCap = 'round';
    localCtx.shadowColor = 'rgba(0,0,0,0.3)';
    localCtx.shadowBlur = 4;
    localCtx.shadowOffsetX = 1;
    localCtx.shadowOffsetY = 1;

    for (let r = 0; r < LOCAL_ROWS; r++) {
      for (let c = 0; c < LOCAL_COLS - 1; c++) {
        const val = localHorizontalLines[r][c];
        if (val) {
          localCtx.strokeStyle = (lastLocalLine && lastLocalLine.type === 'H' && lastLocalLine.r === r && lastLocalLine.c === c) ? '#FFA500' : (val === LOCAL_PLAYER1 ? settings.lineColor : "#d32f2f");
          localCtx.beginPath();
          localCtx.moveTo(LOCAL_PADDING + c * LOCAL_CELL_SIZE, LOCAL_PADDING + r * LOCAL_CELL_SIZE);
          localCtx.lineTo(LOCAL_PADDING + (c + 1) * LOCAL_CELL_SIZE, LOCAL_PADDING + r * LOCAL_CELL_SIZE);
          localCtx.stroke();
        }
      }
    }
    for (let r = 0; r < LOCAL_ROWS - 1; r++) {
      for (let c = 0; c < LOCAL_COLS; c++) {
        const val = localVerticalLines[r][c];
        if (val) {
          localCtx.strokeStyle = (lastLocalLine && lastLocalLine.type === 'V' && lastLocalLine.r === r && lastLocalLine.c === c) ? '#FFA500' : (val === LOCAL_PLAYER1 ? settings.lineColor : "#d32f2f");
          localCtx.beginPath();
          localCtx.moveTo(LOCAL_PADDING + c * LOCAL_CELL_SIZE, LOCAL_PADDING + r * LOCAL_CELL_SIZE);
          localCtx.lineTo(LOCAL_PADDING + c * LOCAL_CELL_SIZE, LOCAL_PADDING + (r + 1) * LOCAL_CELL_SIZE);
          localCtx.stroke();
        }
      }
    }
    localCtx.shadowBlur = 0;
  }

  function drawLocalBoxes() {
    if (!localCtx) return;
    for (let r = 0; r < LOCAL_ROWS - 1; r++) {
      for (let c = 0; c < LOCAL_COLS - 1; c++) {
        if (localBoxes[r][c]) {
          localCtx.fillStyle = localBoxes[r][c] === LOCAL_PLAYER1 ? hexToRgba(settings.boxFillColor, 0.3) : "rgba(211, 47, 47, 0.3)";
          localCtx.fillRect(LOCAL_PADDING + c * LOCAL_CELL_SIZE, LOCAL_PADDING + r * LOCAL_CELL_SIZE, LOCAL_CELL_SIZE, LOCAL_CELL_SIZE);
          localCtx.font = `${LOCAL_CELL_SIZE * 0.4}px Roboto`;
          localCtx.fillStyle = localBoxes[r][c] === LOCAL_PLAYER1 ? settings.boxFillColor : "#d32f2f";
          localCtx.textAlign = 'center';
          localCtx.textBaseline = 'middle';
          localCtx.fillText(localBoxes[r][c] === LOCAL_PLAYER1 ? "üîµ" : "üî¥", LOCAL_PADDING + c * LOCAL_CELL_SIZE + LOCAL_CELL_SIZE / 2, LOCAL_PADDING + r * LOCAL_CELL_SIZE + LOCAL_CELL_SIZE / 2);
        }
      }
    }
  }

  function handleLocalClick(e) {
    if (isLocalGameOver) return;
    const rect = localCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    let moveMade = false;
    let r = -1, c = -1, type = '';

    const touchTolerance = LOCAL_CELL_SIZE * 0.2;

    // Horizontal lines - FIXED: Check both x and y coordinates more accurately
    for (let row = 0; row < LOCAL_ROWS; row++) {
      for (let col = 0; col < LOCAL_COLS - 1; col++) {
        const lineX = col * LOCAL_CELL_SIZE + LOCAL_PADDING;
        const lineY = row * LOCAL_CELL_SIZE + LOCAL_PADDING;
        const lineEndX = lineX + LOCAL_CELL_SIZE;
        const lineEndY = lineY;
        
        // Check if click is near the horizontal line
        const distanceToLine = Math.abs(y - lineY);
        const isWithinXBounds = x >= lineX - touchTolerance && x <= lineEndX + touchTolerance;
        
        if (distanceToLine <= touchTolerance && isWithinXBounds) {
          if (!localHorizontalLines[row][col]) {
            localHorizontalLines[row][col] = localCurrentPlayer;
            playSound(lineSound);
            r = row; c = col; type = "H";
            moveMade = true;
            break;
          }
        }
      }
      if (moveMade) break;
    }

    // Vertical lines - FIXED: Check both x and y coordinates more accurately
    if (!moveMade) {
      for (let row = 0; row < LOCAL_ROWS - 1; row++) {
        for (let col = 0; col < LOCAL_COLS; col++) {
          const lineX = col * LOCAL_CELL_SIZE + LOCAL_PADDING;
          const lineY = row * LOCAL_CELL_SIZE + LOCAL_PADDING;
          const lineEndX = lineX;
          const lineEndY = lineY + LOCAL_CELL_SIZE;
          
          // Check if click is near the vertical line
          const distanceToLine = Math.abs(x - lineX);
          const isWithinYBounds = y >= lineY - touchTolerance && y <= lineEndY + touchTolerance;
          
          if (distanceToLine <= touchTolerance && isWithinYBounds) {
            if (!localVerticalLines[row][col]) {
              localVerticalLines[row][col] = localCurrentPlayer;
              playSound(lineSound);
              r = row; c = col; type = "V";
              moveMade = true;
              break;
            }
          }
        }
        if (moveMade) break;
      }
    }

    if (moveMade) {
      lastLocalLine = { r, c, type };
      handleLocalMove(r, c, type);
    }
  }

  function handleLocalMove(r, c, type) {
    let completedBoxes = 0;
    let boxX = 0, boxY = 0;
    if (type === "H") {
      if (r > 0 && checkLocalBox(r - 1, c)) {
        completedBoxes += claimLocalBox(r - 1, c);
      }
      if (r < LOCAL_ROWS - 1 && checkLocalBox(r, c)) {
        completedBoxes += claimLocalBox(r, c);
      }
      boxX = (c + 0.5) * LOCAL_CELL_SIZE + LOCAL_PADDING;
      boxY = r * LOCAL_CELL_SIZE + LOCAL_PADDING;
    } else {
      if (c > 0 && checkLocalBox(r, c - 1)) {
        completedBoxes += claimLocalBox(r, c - 1);
      }
      if (c < LOCAL_COLS - 1 && checkLocalBox(r, c)) {
        completedBoxes += claimLocalBox(r, c);
      }
      boxX = c * LOCAL_CELL_SIZE + LOCAL_PADDING;
      boxY = (r + 0.5) * LOCAL_CELL_SIZE + LOCAL_PADDING;
    }
    
    drawLocal();
    checkAndSwitchMusic(localPlayerScore + localAiScore, localGameGridSize);

    if(completedBoxes > 1) {
      showConsecutiveBoxPopup(completedBoxes);
    }
    if(completedBoxes > 0) {
      launchSparks(boxX, boxY, localCanvas);
    }

    if (completedBoxes === 0 || !settings.extraTurnEnabled) {
      localCurrentPlayer = localCurrentPlayer === LOCAL_PLAYER1 ? LOCAL_PLAYER2 : LOCAL_PLAYER1;
      updateLocalTurnIndicator();
    }

    checkLocalWin();
  }

  function checkLocalBox(r, c) {
    if (r < 0 || r >= LOCAL_ROWS - 1 || c < 0 || c >= LOCAL_COLS - 1) return false;
    return localHorizontalLines[r][c] &&
           localHorizontalLines[r + 1][c] &&
           localVerticalLines[r][c] &&
           localVerticalLines[r][c + 1];
  }

  function claimLocalBox(r, c) {
    if (localBoxes[r][c]) return 0;
    localBoxes[r][c] = localCurrentPlayer;
    playSound(boxSound);
    if (localCurrentPlayer === LOCAL_PLAYER1) localPlayerScore++;
    else localAiScore++;
    updateLocalScores();
    return 1;
  }

  function updateLocalScores() {
    const playerScoreElement = document.getElementById("local-playerScore");
    if (playerScoreElement) playerScoreElement.textContent = localPlayerScore;
    const aiScoreElement = document.getElementById("local-aiScore");
    if (aiScoreElement) aiScoreElement.textContent = localAiScore;
    
    const p1NameElement = document.getElementById('local-p1-name');
    const p2NameElement = document.getElementById('local-p2-name');
    if (p1NameElement) p1NameElement.textContent = `${localPlayer1Name}: ${localPlayerScore}`;
    if (p2NameElement) p2NameElement.textContent = `${localPlayer2Name}: ${localAiScore}`;
  }
  
  function updateLocalTurnIndicator() {
    const p1Indicator = document.getElementById('local-p1-indicator');
    const p2Indicator = document.getElementById('local-p2-indicator');
    if (p1Indicator) {
      p1Indicator.classList.toggle('active', localCurrentPlayer === LOCAL_PLAYER1);
      p1Indicator.classList.toggle('pulse', localCurrentPlayer === LOCAL_PLAYER1);
    }
    if (p2Indicator) {
      p2Indicator.classList.toggle('active', localCurrentPlayer === LOCAL_PLAYER2);
      p2Indicator.classList.toggle('pulse', localCurrentPlayer === LOCAL_PLAYER2);
    }
  }

  function checkLocalWin() {
    const total = (LOCAL_ROWS - 1) * (LOCAL_COLS - 1);
    if (localPlayerScore + localAiScore === total && !isLocalGameOver) {
      isLocalGameOver = true;
      playSound(winSound);
      updateMatchHistory('local');
      setTimeout(() => {
        let msg = "";
        if (localPlayerScore > localAiScore) msg = `üéâ ${localPlayer1Name} Wins!`;
        else if (localAiScore > localPlayerScore) msg = `üéâ ${localPlayer2Name} Wins!`;
        else msg = "ü§ù It's a Tie!";
        const resultText = document.getElementById("local-resultText");
        if (resultText) resultText.textContent = msg;
        const popup = document.getElementById("local-popup");
        if (popup) popup.style.display = "block";
        launchConfetti();
        stopIntenseMusic();
      }, getAnimationSpeed());
    }
  }

  function restartLocalGame() {
    playSound(tapSound);
    initLocalGame(localGameGridSize);
  }

  // ====================================================================================
  // Utility and Animation Logic
  // ====================================================================================

  function launchConfetti() {
    const confettiCanvas = document.getElementById('confetti-canvas');
    if (!confettiCanvas || !confetti) return;
    const confettiCannon = confetti.create(confettiCanvas, { resize: true });
    confettiCannon({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
  }
  
  function launchSparks(x, y, canvas) {
    if (!sparkleCanvas || !canvas) return;
    const rect = canvas.getBoundingClientRect();
    const numSparks = Math.floor(Math.random() * 5) + 5;
    for (let i = 0; i < numSparks; i++) {
      sparkles.push({
        x: rect.left + x,
        y: rect.top + y,
        vx: (Math.random() - 0.5) * 5,
        vy: (Math.random() - 0.5) * 5 - 2,
        life: 50,
        color: `hsl(${Math.random() * 360}, 100%, 50%)`
      });
    }
  }

  function updateSparkles() {
    if (!sparkleCtx) return;
    sparkleCtx.clearRect(0, 0, sparkleCanvas.width, sparkleCanvas.height);
    sparkles = sparkles.filter(sparkle => sparkle.life > 0);
    sparkles.forEach(sparkle => {
      sparkle.x += sparkle.vx;
      sparkle.y += sparkle.vy;
      sparkle.vy += 0.1;
      sparkle.life--;

      sparkleCtx.beginPath();
      sparkleCtx.arc(sparkle.x, sparkle.y, 2, 0, Math.PI * 2);
      sparkleCtx.fillStyle = sparkle.color;
      sparkleCtx.fill();
    });
    requestAnimationFrame(updateSparkles);
  }

  // ====================================================================================
  // Initialisation on Page Load
  // ====================================================================================

  window.onload = () => {
    try {
      loadSettings();
      const storedCoins = localStorage.getItem("coinCount");
      const coinCountElement = document.getElementById("coinCount");
      if (storedCoins && coinCountElement) {
        coinCountElement.innerText = storedCoins;
      } else {
        localStorage.setItem("coinCount", 0);
      }
      
      checkRewardStatus();
      
      // Check if user is already logged in
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
        showScreen('home-screen');
      } else {
        showScreen('login-screen');
      }

      const storedPhoto = localStorage.getItem("userPhoto");
      const userPhoto = document.getElementById("userPhoto");
      if(storedPhoto && userPhoto) {
        userPhoto.src = storedPhoto;
      }
      if (sparkleCanvas) {
        sparkleCanvas.width = window.innerWidth;
        sparkleCanvas.height = window.innerHeight;
        updateSparkles();
      }
    } catch(e) {
      console.error("Initialization error:", e);
    }
  }
</script>
</body>
</html>